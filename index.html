<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>飲料紀錄</title>

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="飲料紀錄" />

  <!-- iOS 主畫面 icon -->
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.PNG">
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">

  <!-- favicon -->
  <link rel="icon" type="image/png" href="./apple-touch-icon.PNG">
  <link rel="icon" type="image/png" href="./apple-touch-icon.png">

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');

    :root{
      --main:#8A9A5B;
      --main-dark:#556B2F;
      --bg:#F2F4EF;
      --weekend:#C08282;
      --today-border:#CFE0B8;

      --year-accent:#CD5C5C;   /* 年度：紅 */
      --month-accent:#8A9A5B;  /* 本月：綠 */
      --year-tint: rgba(205,92,92,.16);
      --month-tint: rgba(138,154,91,.18);
    }

    html, body { height: 100%; background: var(--bg); }
    body{
      font-family:'Noto Sans TC', system-ui, -apple-system, "PingFang TC", "Heiti TC", sans-serif;
      -webkit-tap-highlight-color: transparent;
      background: var(--bg);
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      overscroll-behavior-y: none;
    }
    .no-scrollbar::-webkit-scrollbar{ display:none; }

    #app{ height: 100svh; }

    /* 日曆縮短 */
    .calendar-wrap{
      flex: 1 1 auto;
      min-height: 0;
      display:flex;
      flex-direction:column;
    }
    .calendar-grid{
      display:grid;
      grid-template-columns:repeat(7, minmax(0,1fr));
      gap: 10px;
      padding: 8px;
    }
    .day-cell{
      height: clamp(40px, 7.2vh, 56px);
      border-radius: 18px;
    }
    .today-ring{
      outline: 2px solid var(--today-border);
      outline-offset: -2px;
    }

    .modal-sheet{
      max-height: 85svh;
      overflow-y:auto;
      -webkit-overflow-scrolling: touch;
    }

    /* iOS IME 避免跳字 */
    input, button{ font-size: 16px; }

    /* 多行省略（不用 tailwind plugin） */
    .line2{
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      overflow: hidden;
    }
    .line1{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* TOP 小卡：固定高度避免撐版 */
    .top-card{
      height: 64px;
    }
    .top-badge{
      font-size: 10px;
      line-height: 1;
    }

    /* 錯誤遮罩（避免白畫面） */
    #fatalError {
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: none;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(8px);
      padding: 18px;
    }
    #fatalError .box{
      max-width: 420px;
      margin: 10vh auto 0;
      background: #fff;
      border-radius: 28px;
      padding: 18px;
      box-shadow: 0 24px 60px rgba(0,0,0,.25);
    }
    #fatalError .title{
      color: #b91c1c;
      font-weight: 900;
      font-size: 18px;
      margin-bottom: 10px;
    }
    #fatalError pre{
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 12px;
      background: #f3f4f6;
      border-radius: 16px;
      padding: 12px;
      margin: 0;
      max-height: 45vh;
      overflow: auto;
    }
  </style>
</head>

<body>
  <div id="app" class="max-w-md mx-auto px-4 flex flex-col overflow-hidden"></div>

  <!-- Fatal error overlay -->
  <div id="fatalError">
    <div class="box">
      <div class="title">JS Error</div>
      <pre id="fatalMsg"></pre>
      <button id="fatalClose" class="w-full mt-4 py-3 rounded-xl font-black text-white" style="background:var(--main-dark)">關閉</button>
    </div>
  </div>

  <script>
    /********************
     * 防白畫面：任何錯誤都顯示
     ********************/
    window.addEventListener("error", (e)=>{
      showFatal(`${e.message}\n\n${e.filename || ""}:${e.lineno || ""}:${e.colno || ""}`);
    });
    window.addEventListener("unhandledrejection", (e)=>{
      const msg = (e.reason && (e.reason.stack || e.reason.message)) ? (e.reason.stack || e.reason.message) : String(e.reason);
      showFatal(msg);
    });
    function showFatal(message){
      const el = document.getElementById("fatalError");
      const msg = document.getElementById("fatalMsg");
      msg.textContent = message || "Unknown error";
      el.style.display = "block";
    }
    document.getElementById("fatalClose").onclick = ()=> {
      document.getElementById("fatalError").style.display = "none";
    };

    /********************
     * Storage Keys
     ********************/
    const KEY_TITLE = "fpj_app_title";
    const KEY_DATA  = "fpj_offline_data_v3";
    const KEY_SHOPS = "fpj_shop_list_v1";

    /********************
     * Options
     ********************/
    const iceOptions   = ["正常","少冰","微冰","去冰","常溫","溫","熱","固定"];
    const sugarOptions = ["全糖","少糖","半糖","微糖","一分","0.5分","無糖","固定"];

    const defaultShops = ["五十嵐","可不可","麻古","得正","五桐號","鶴茶樓","迷客夏","大苑子"];

    /********************
     * State
     ********************/
    const today = new Date();
    let state = {
      currentDate: new Date(today.getFullYear(), today.getMonth(), 1),
      selectedDate: null,

      appTitle: localStorage.getItem(KEY_TITLE) || "一隻肥豬嘉的誕生",
      isEditingTitle: false,

      records: safeParse(localStorage.getItem(KEY_DATA)) || {},

      shops: loadShops(),

      shopPicker: { open:false, idx:null, manage:false }, // manage: 顯示刪除
    };

    function safeParse(s){
      try{ return JSON.parse(s); }catch(err){ return null; }
    }
    function saveData(){
      localStorage.setItem(KEY_DATA, JSON.stringify(state.records));
    }
    function saveTitle(t){
      state.appTitle = t;
      localStorage.setItem(KEY_TITLE, t);
    }

    function loadShops(){
      const saved = safeParse(localStorage.getItem(KEY_SHOPS));
      if(Array.isArray(saved) && saved.length){
        // 去重 + 清理空白
        const uniq = [];
        for(const s of saved){
          const v = String(s||"").trim();
          if(v && !uniq.includes(v)) uniq.push(v);
        }
        // 確保預設都在
        for(const s of defaultShops){
          if(!uniq.includes(s)) uniq.unshift(s);
        }
        return uniq;
      }
      return [...defaultShops];
    }
    function saveShops(){
      localStorage.setItem(KEY_SHOPS, JSON.stringify(state.shops));
    }

    function formatDateKey(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${dd}`;
    }
    function sameDay(a,b){
      return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
    }
    function ensureDayArray(dateKey){
      if(!state.records[dateKey]) state.records[dateKey] = [];
      return state.records[dateKey];
    }

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /********************
     * Display helpers
     ********************/
    function normalizeShop(s){ return String(s||"").trim(); }
    function normalizeItem(s){ return String(s||"").trim(); }
    function sugarIceLabel(d){
      const s = (d.sugar || "無糖");
      const i = (d.ice || "去冰");
      return `${s}/${i}`;
    }
    function comboKeyByShopItem(d){
      const shop = normalizeShop(d.shop);
      const item = normalizeItem(d.item);
      if(!shop || !item) return null;
      return `${shop}—${item}`; // 用 em dash 避免一些奇怪字元造成識別問題
    }

    /********************
     * Stats (Year/Month + TOP)
     ********************/
    function calculateStats(){
      const y = state.currentDate.getFullYear();
      const m = state.currentDate.getMonth();

      let yTotal=0, yCount=0, mTotal=0, mCount=0;

      // 常喝排行：以「店家-品項」為 key
      // 但同時統計甜度/冰量分佈，用來顯示「最常設定」
      const freq = {}; // key -> { total, sugarIceCount: { "無糖/去冰":7, ... } }

      // good/bad
      const goodList = [];
      const badList  = [];

      for(const key of Object.keys(state.records)){
        const dt = new Date(key);
        const isYear  = dt.getFullYear() === y;
        const isMonth = isYear && dt.getMonth() === m;

        for(const drink of (state.records[key]||[])){
          const price = Number(drink.price || 0);

          if(isYear){ yTotal += price; yCount++; }
          if(isMonth){ mTotal += price; mCount++; }

          const ck = comboKeyByShopItem(drink);
          if(ck){
            if(!freq[ck]) freq[ck] = { total:0, sugarIceCount:{} };
            freq[ck].total += 1;

            const si = sugarIceLabel(drink);
            freq[ck].sugarIceCount[si] = (freq[ck].sugarIceCount[si]||0) + 1;
          }

          if(drink.rating === "good") goodList.push({drink, date:key});
          if(drink.rating === "bad")  badList.push({drink, date:key});
        }
      }

      // 排序：總次數
      const ranked = Object.entries(freq)
        .map(([k,v])=>{
          const [shop,item] = k.split("—");
          const topSI = topSugarIce(v.sugarIceCount);
          return {
            key: k,
            shop, item,
            total: v.total,
            topSugarIce: topSI.label,      // 例如 無糖/去冰
            topSugarIceCount: topSI.count, // 例如 7
          };
        })
        .sort((a,b)=>{
          if(b.total !== a.total) return b.total - a.total;
          // 次數相同就字典序，避免跳動
          return (a.key > b.key) ? 1 : -1;
        });

      const top3 = ranked.slice(0,3);

      return { yTotal, yCount, mTotal, mCount, top3, ranked, goodList, badList };
    }

    function topSugarIce(map){
      let bestLabel = "無糖/去冰";
      let bestCount = 0;
      for(const [k,v] of Object.entries(map||{})){
        if(v > bestCount){
          bestCount = v;
          bestLabel = k;
        }
      }
      if(bestCount === 0) return { label:"無糖/去冰", count:0 };
      return { label: bestLabel, count: bestCount };
    }

    /********************
     * Icons (outline)
     ********************/
    function thumbIcon(color){
      return `
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3z"/>
          <path d="M7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/>
        </svg>
      `;
    }
    function thumbDownIcon(color){
      return `
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3z"/>
          <path d="M17 2h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2h-3"/>
        </svg>
      `;
    }

    // TOP 圓形圖示（空心）
    function topCircleIcon(color){
      return `
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="9"></circle>
          <path d="M8 9h8"></path>
          <path d="M9 12h6"></path>
          <path d="M10 15h4"></path>
        </svg>
      `;
    }

    /********************
     * Render
     ********************/
    function render(){
      const app = document.getElementById("app");
      const stats = calculateStats();

      const year = state.currentDate.getFullYear();
      const month = state.currentDate.getMonth();
      const daysInMonth = new Date(year, month+1, 0).getDate();
      const firstDay = new Date(year, month, 1).getDay();

      // title
      let titleHtml = "";
      if(state.isEditingTitle){
        titleHtml = `
          <input id="titleInput" type="text"
            class="text-xl font-black text-[var(--main)] text-center bg-white rounded-full px-4 py-2 border-2 border-[var(--main)] w-full max-w-[280px] outline-none"
            value="${escapeHtml(state.appTitle)}" />
        `;
      }else{
        titleHtml = `
          <div id="titleDisplay" class="flex items-center gap-2 cursor-pointer active:opacity-60 select-none">
            <h1 class="text-xl font-black tracking-widest text-[var(--main)]">${escapeHtml(state.appTitle)}</h1>
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--main)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-50">
              <path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
            </svg>
          </div>
        `;
      }

      // calendar cells
      let calendarCells = "";
      for(let i=0;i<firstDay;i++){
        calendarCells += `<div></div>`;
      }
      for(let d=1; d<=daysInMonth; d++){
        const dateObj = new Date(year, month, d);
        const key = formatDateKey(dateObj);
        const list = state.records[key] || [];
        const count = list.length;
        const isWeekend = ((firstDay + d - 1) % 7 === 0) || ((firstDay + d - 1) % 7 === 6);
        const isToday = sameDay(dateObj, today);

        let bgClass = "bg-white/40";
        if(count===1) bgClass = "bg-[#E1EAD1]";
        if(count===2) bgClass = "bg-[#FEF5D4]";
        if(count>=3) bgClass = "bg-[#FEE2E2]";

        const daySum = count>0 ? list.reduce((s,i)=>s+Number(i.price||0),0) : 0;

        calendarCells += `
          <button data-day="${d}" class="day-cell ${bgClass} ${isToday ? "today-ring" : ""} w-full flex flex-col items-center justify-center border border-white/60 shadow-sm active:scale-95 transition-transform relative">
            <span class="text-[12px] font-black" style="color:${isWeekend ? 'var(--weekend)' : 'var(--main-dark)'}">${d}</span>
            ${count>0 ? `<span class="text-[9px] font-bold text-slate-400 leading-none mt-0.5">$${daySum}</span>` : ``}
          </button>
        `;
      }

      // TOP 3 cards
      const topCards = (stats.top3 && stats.top3.length)
        ? stats.top3.map((t,idx)=>`
            <div class="top-card flex-shrink-0 bg-white px-3 py-2 rounded-xl border border-[#E1EAD1] min-w-[96px] max-w-[110px] flex flex-col justify-between">
              <div class="text-[10px] font-black text-[var(--main-dark)] line1">${escapeHtml(t.shop)}</div>
              <div class="text-[10px] font-black text-slate-500 line1">${escapeHtml(t.item)}</div>
              <div class="mt-1 flex items-center justify-between gap-1">
                <span class="top-badge px-2 py-1 rounded-lg bg-[#F2F4EF] text-[#7A8B53] font-black line1">
                  ${escapeHtml(t.topSugarIce)}
                </span>
                <span class="text-[10px] font-black text-slate-300 shrink-0">${t.total}次</span>
              </div>
            </div>
          `).join("")
        : `<span class="text-[10px] text-slate-400 italic pl-2">尚未產生排名...</span>`;

      const goodCount = stats.goodList.length;
      const badCount  = stats.badList.length;

      app.innerHTML = `
        <!-- Header -->
        <div class="flex justify-center items-center pt-4 pb-3 shrink-0">
          ${titleHtml}
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-2 gap-3 mb-3 shrink-0">
          <!-- 年度 -->
          <div class="bg-white/80 p-3 rounded-[1.5rem] shadow-sm border border-white text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-[6px]" style="background: var(--year-tint)"></div>
            <div class="absolute top-0 left-0 w-full h-[2px]" style="background: rgba(205,92,92,.55)"></div>
            <p class="text-[10px] font-black mb-1 tracking-widest" style="color:var(--year-accent)">年度累計</p>
            <p class="text-sm font-black text-slate-700">
              ${stats.yCount} <span class="text-[10px] text-slate-400">杯</span>
              <span class="ml-1" style="color:var(--year-accent)">$${stats.yTotal.toLocaleString()}</span>
            </p>
          </div>

          <!-- 本月 -->
          <div class="bg-white/80 p-3 rounded-[1.5rem] shadow-sm border border-white text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-[6px]" style="background: var(--month-tint)"></div>
            <div class="absolute top-0 left-0 w-full h-[2px]" style="background: rgba(138,154,91,.65)"></div>
            <p class="text-[10px] font-black mb-1 tracking-widest" style="color:var(--month-accent)">本月統計</p>
            <p class="text-sm font-black text-slate-700">
              ${stats.mCount} <span class="text-[10px] text-slate-400">杯</span>
              <span class="ml-1" style="color:var(--main-dark)">$${stats.mTotal.toLocaleString()}</span>
            </p>
          </div>
        </div>

        <!-- Month Selector -->
        <div class="flex justify-center mb-3 shrink-0">
          <div class="flex items-center gap-6 bg-white/60 px-6 py-2 rounded-full border border-white/40 shadow-sm">
            <button id="prevMonth" class="text-[var(--main)] font-black text-lg active:scale-75 transition-transform">〈</button>
            <p class="font-black text-base tracking-tighter text-[var(--main-dark)] min-w-[88px] text-center">
              ${year}.${String(month+1).padStart(2,'0')}
            </p>
            <button id="nextMonth" class="text-[var(--main)] font-black text-lg active:scale-75 transition-transform">〉</button>
            <button id="goToday" class="ml-1 px-3 py-1.5 rounded-full bg-white/70 border border-white/60 text-[11px] font-black text-[var(--main-dark)] active:scale-95 transition-transform">今天</button>
          </div>
        </div>

        <!-- Calendar -->
        <div class="calendar-wrap bg-white/95 rounded-[2rem] shadow-sm border border-white mb-3 overflow-hidden">
          <div class="grid grid-cols-7 px-4 pt-4 pb-1 text-center shrink-0">
            ${['日','一','二','三','四','五','六'].map((d,i)=>`
              <div class="text-[10px] font-black" style="color:${(i===0||i===6)?'var(--weekend)':'#A5B997'}">${d}</div>
            `).join('')}
          </div>
          <div class="calendar-grid flex-1 min-h-0">
            ${calendarCells}
          </div>
        </div>

        <!-- Bottom -->
        <div class="shrink-0 space-y-3 pb-3">
          <!-- TOP 3 (點整塊看排行清單) -->
          <button id="openTopRank" class="w-full bg-white/70 px-4 py-3 rounded-[1.5rem] border border-white shadow-sm flex items-center gap-3 active:scale-[0.99] transition-transform">
            <div class="w-11 h-11 rounded-full flex items-center justify-center shrink-0" style="border:2px solid var(--main);">
              ${topCircleIcon("var(--main-dark)")}
            </div>
            <div class="flex gap-2 overflow-x-auto no-scrollbar flex-1 items-center">
              ${topCards}
            </div>
          </button>

          <!-- Good/Bad -->
          <div class="grid grid-cols-2 gap-3">
            <button id="openGood" class="bg-white/70 py-4 rounded-[1.2rem] border border-white flex items-center justify-center gap-2 text-[12px] font-black shadow-sm active:scale-95 transition-transform text-[var(--main-dark)]">
              ${thumbIcon("var(--main-dark)")}
              <span>讚讚 (${goodCount})</span>
            </button>

            <button id="openBad" class="bg-white/70 py-4 rounded-[1.2rem] border border-white flex items-center justify-center gap-2 text-[12px] font-black shadow-sm active:scale-95 transition-transform text-[#B56B6B]">
              ${thumbDownIcon("#B56B6B")}
              <span>踩雷 (${badCount})</span>
            </button>
          </div>
        </div>
      `;

      wireMainEvents();

      if(state.isEditingTitle){
        const input = document.getElementById("titleInput");
        input.focus();
        input.addEventListener("blur", ()=>{
          const v = (input.value||"").trim();
          if(v) saveTitle(v);
          state.isEditingTitle = false;
          render();
        }, { once:true });
      }
    }

    /********************
     * Main Events
     ********************/
    function wireMainEvents(){
      const titleDisplay = document.getElementById("titleDisplay");
      if(titleDisplay){
        titleDisplay.onclick = ()=>{
          state.isEditingTitle = true;
          render();
        };
      }

      document.getElementById("prevMonth").onclick = ()=>{
        state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth()-1, 1);
        render();
      };
      document.getElementById("nextMonth").onclick = ()=>{
        state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth()+1, 1);
        render();
      };
      document.getElementById("goToday").onclick = ()=>{
        state.currentDate = new Date(today.getFullYear(), today.getMonth(), 1);
        render();
      };

      document.querySelectorAll("[data-day]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const day = Number(btn.getAttribute("data-day"));
          openEditModal(day);
        });
      });

      document.getElementById("openGood").onclick = ()=> openListModal("good");
      document.getElementById("openBad").onclick  = ()=> openListModal("bad");

      document.getElementById("openTopRank").onclick = ()=> openTopRankModal();
    }

    /********************
     * Edit Modal
     ********************/
    function openEditModal(day){
      state.selectedDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), day);
      const dateKey = formatDateKey(state.selectedDate);
      ensureDayArray(dateKey);

      const modal = document.createElement("div");
      modal.id = "editModal";
      modal.className = "fixed inset-0 bg-[var(--main-dark)]/40 backdrop-blur-md z-[100] flex items-end";
      modal.innerHTML = `
        <div class="modal-sheet bg-[#FAFBF9] w-full rounded-t-[2.5rem] p-6 pb-10 shadow-2xl no-scrollbar">
          <div class="flex justify-between items-center mb-5">
            <h3 class="text-xl font-black text-[var(--main-dark)]">${state.selectedDate.getMonth()+1}月${state.selectedDate.getDate()}日</h3>
            <button id="closeEdit" class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm text-slate-300 text-lg">✕</button>
          </div>

          <div id="drinkList" class="space-y-4"></div>

          <button id="saveClose" class="w-full mt-6 py-4 bg-[var(--main-dark)] text-white rounded-[1.5rem] font-black text-base shadow-xl active:scale-95 transition-transform">
            儲存紀錄
          </button>
        </div>
      `;

      const old = document.getElementById("editModal");
      if(old) old.remove();

      document.body.appendChild(modal);

      document.getElementById("closeEdit").onclick = closeEditModal;
      document.getElementById("saveClose").onclick = closeEditModal;

      renderDrinkCards();
    }

    function closeEditModal(){
      const m = document.getElementById("editModal");
      if(m) m.remove();
      render();
    }

    function defaultDrink(){
      return { shop:"", item:"", ice:"去冰", sugar:"無糖", price:0, rating:null };
    }

    function renderDrinkCards(){
      const dateKey = formatDateKey(state.selectedDate);
      const list = ensureDayArray(dateKey);

      const container = document.getElementById("drinkList");
      container.innerHTML = "";

      for(let idx=0; idx<3; idx++){
        const drink = list[idx];
        const exists = !!drink;

        const canShow =
          idx===0 ||
          (list[idx-1] && (String(list[idx-1].item||"").trim() !== "" || String(list[idx-1].shop||"").trim() !== "")) ||
          exists;

        if(!canShow) continue;

        if(!exists){
          const add = document.createElement("div");
          add.className = "p-5 rounded-[2rem] bg-[#F2F4EF] border-2 border-dashed border-[#DDE4D1]";
          add.innerHTML = `
            <button class="w-full py-4 text-[#A5B997] font-black text-xs flex flex-col items-center gap-1 active:opacity-60">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <path d="M12 5v14"></path><path d="M5 12h14"></path>
              </svg>
              新增第 ${idx+1} 杯
            </button>
          `;
          add.querySelector("button").onclick = ()=>{
            while(list.length <= idx) list.push(defaultDrink());
            saveData();
            renderDrinkCards();
            setTimeout(()=>{
              const el = document.querySelector(`[data-field="shop"][data-idx="${idx}"]`);
              if(el) el.click(); // 直接打開店家選擇
            },