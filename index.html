<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>è‚¥è±¬å˜‰é£²æ–™ç´€éŒ„</title>

  <!-- iOS ä¸»ç•«é¢ iconï¼ˆæª”åå¤§å°å¯«è¦å®Œå…¨ä¸€è‡´ï¼šPNGï¼‰ -->
  <link rel="apple-touch-icon" href="./apple-touch-icon.PNG">
  <link rel="apple-touch-icon-precomposed" href="./apple-touch-icon.PNG">
  <link rel="icon" type="image/png" href="./apple-touch-icon.PNG">

  <!-- é¿å…ä¸»ç•«é¢é¡¯ç¤ºé¦–å­—ã€Œè‚¥ã€ -->
  <meta name="apple-mobile-web-app-title" content="è‚¥è±¬å˜‰é£²æ–™ç´€éŒ„">
  <meta name="application-name" content="è‚¥è±¬å˜‰é£²æ–™ç´€éŒ„">
  <meta name="theme-color" content="#eef2ea">

  <style>
    :root{
      --bg:#eef2ea;
      --card:#ffffffcc;
      --ink:#596b3a;
      --ink2:#7c8a5f;
      --muted:#a7b09a;
      --line:#dfe6d6;
      --shadow:0 10px 25px rgba(33,40,24,.08);
      --radius:22px;

      --red:#c77b7b;
      --redLite:#f0dada;

      --green:#6f7f46;
      --greenLite:#dfe7d3;

      --pill:#e8ece2;
      --pillText:#647055;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-rounded, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      background: radial-gradient(1200px 700px at 50% -120px, #f7faf4 0%, var(--bg) 55%, #e9eee3 100%);
      color:var(--ink);
    }

    /* ç›¡é‡ã€Œä¸€é çœ‹å®Œã€ï¼šç”¨ svh é¿å… iOS åœ°å€åˆ—æäº‹ */
    .app{
      max-width:420px;
      margin:0 auto;
      padding:14px 14px 16px;
      min-height:100svh;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* title */
    .titleRow{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      margin-top:2px;
      position:relative;
      flex:0 0 auto;
    }
    .titleRow h1{
      font-size:20px;
      letter-spacing:.08em;
      margin:0;
      color:var(--ink);
      opacity:.92;
      font-weight:900;
    }

    .titleRow .quickAdd{
      position:absolute;
      right:2px;
      top:50%;
      transform:translateY(-50%);
      width:36px;height:36px;
      border-radius:14px;
      border:1px solid var(--line);
      background:var(--card);
      box-shadow:0 6px 14px rgba(33,40,24,.06);
      display:grid;
      place-items:center;
      cursor:pointer;
    }
    .titleRow .quickAdd svg{ width:18px;height:18px; }

    /* stats */
    .stats{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      flex:0 0 auto;
    }
    .statCard{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:12px 12px 10px;
      position:relative;
      overflow:hidden;
      min-height:74px;
    }
    .strip{
      position:absolute;
      left:10px; right:10px; top:10px;
      height:10px;
      border-radius:999px;
      opacity:.95;
      filter:saturate(1.02);
    }
    .statCard.year .strip{ background:linear-gradient(90deg, var(--redLite), rgba(255,255,255,0)); }
    .statCard.month .strip{ background:linear-gradient(90deg, var(--greenLite), rgba(255,255,255,0)); }

    .statCard .cap{
      font-weight:1000;
      letter-spacing:.18em;
      font-size:12px;
      opacity:.9;
      margin:2px 0 8px;
      text-align:center;
    }
    .statCard .val{
      display:flex;
      justify-content:center;
      gap:8px;
      align-items:baseline;
      font-weight:1000;
      font-size:20px;
    }
    .statCard .val small{
      font-size:14px;
      opacity:.9;
      font-weight:1000;
    }
    .statCard.year .cap, .statCard.year .val{ color:var(--red); }
    .statCard.month .cap, .statCard.month .val{ color:var(--green); }

    /* month nav */
    .monthNav{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:10px 10px;
      display:grid;
      grid-template-columns:44px 1fr 44px 74px;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }
    .navBtn{
      width:44px;height:38px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.8);
      cursor:pointer;
      display:grid;
      place-items:center;
      font-weight:1000;
      color:var(--ink);
    }
    .monthLabel{
      text-align:center;
      font-weight:1000;
      font-size:22px;
      letter-spacing:.05em;
      color:var(--ink);
    }
    .todayBtn{
      height:38px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.8);
      cursor:pointer;
      font-weight:1000;
      letter-spacing:.08em;
      color:var(--ink);
    }

    /* calendar */
    .calWrap{
      background:rgba(255,255,255,.65);
      border:1px solid var(--line);
      border-radius:26px;
      box-shadow:var(--shadow);
      padding:12px 12px 12px;
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .dow{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:8px;
      padding:2px 4px 4px;
      font-weight:1000;
      letter-spacing:.18em;
      color:var(--ink2);
      font-size:12px;
      text-align:center;
      user-select:none;
    }
    .dow div:nth-child(1),
    .dow div:nth-child(7){ color:var(--red); }

    .grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:10px;
      align-content:start;
      flex:1 1 auto;
    }
    .day{
      height:52px;
      border-radius:18px;
      border:1px solid rgba(220,228,214,.85);
      background:rgba(255,255,255,.72);
      box-shadow:0 8px 16px rgba(33,40,24,.04);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      position:relative;
      user-select:none;
      overflow:hidden;
    }
    .day .num{
      font-weight:1000;
      color:var(--ink);
      line-height:1;
      font-size:16px;
    }
    .day .amt{
      margin-top:4px;
      font-weight:1000;
      color:var(--muted);
      font-size:12px;
    }
    .day.muted{
      opacity:.35;
      cursor:default;
      pointer-events:none;
    }
    .day.sun .num, .day.sat .num{ color:var(--red); }
    .day.hasDrink::after{
      content:"";
      position:absolute;
      inset:0;
      border-radius:18px;
      border:2px solid rgba(111,127,70,.22);
      pointer-events:none;
    }
    .day.selected{
      background:rgba(223,231,211,.75);
    }
    .day.selected::after{
      border-color:rgba(111,127,70,.34);
    }

    /* bottom "æˆ‘æœ€å¸¸å–" å›ºå®šå¯¬ï¼ˆè·Ÿæ—¥æ›†åŒå¯¬ï¼‰ */
    .bottomWrap{
      background:rgba(255,255,255,.55);
      border:1px solid var(--line);
      border-radius:26px;
      box-shadow:var(--shadow);
      padding:10px 12px 10px;
      flex:0 0 auto;
    }
    .bottomTitle{
      text-align:center;            /* ä½ è¦ç½®ä¸­ */
      font-weight:1000;
      letter-spacing:.12em;
      color:var(--ink);
      margin:2px 0 8px;
      font-size:14px;
    }
    .topCards{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:10px;
    }
    .miniCard{
      background:rgba(255,255,255,.82);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:0 8px 16px rgba(33,40,24,.05);
      padding:10px 10px;
      cursor:pointer;
      min-height:62px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:6px;
      min-width:0;
    }
    .miniCard .s{
      font-weight:1000;
      color:var(--ink);
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .miniCard .i{
      font-weight:1000;
      color:var(--ink2);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .miniCard.empty{
      cursor:default;
      opacity:.55;
    }
    .hint{
      text-align:center;
      color:var(--muted);
      font-weight:1000;
      letter-spacing:.05em;
      font-size:12px;
      margin-top:6px;
      user-select:none;
    }

    /* actions row */
    .actions{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      flex:0 0 auto;
    }
    .actionBtn{
      background:rgba(255,255,255,.65);
      border:1px solid var(--line);
      border-radius:20px;
      box-shadow:var(--shadow);
      padding:12px 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-weight:1000;
      letter-spacing:.08em;
      cursor:pointer;
      user-select:none;
    }
    .actionBtn.like{ color:var(--green); }
    .actionBtn.dislike{ color:var(--red); }
    .actionBtn svg{ width:20px;height:20px; }

    /* overlay / modal */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.28);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .overlay.show{ display:flex; }
    .modal{
      width:min(420px, 100%);
      background:rgba(255,255,255,.92);
      border:1px solid var(--line);
      border-radius:26px;
      box-shadow:0 30px 60px rgba(0,0,0,.18);
      padding:16px 16px 14px;
      position:relative;
      backdrop-filter: blur(6px);
      max-height:88svh;
      overflow:auto;
    }
    .modal h3{
      margin:4px 0 12px;
      text-align:center;
      font-size:20px;
      letter-spacing:.12em;
      font-weight:1000;
      color:var(--ink);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
    }
    .modal .closeX{
      position:absolute;
      right:12px;
      top:10px;
      width:34px;height:34px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.8);
      cursor:pointer;
      display:grid;
      place-items:center;
      font-weight:1000;
      color:var(--ink2);
    }

    .primaryBtn{
      width:100%;
      height:54px;
      border:none;
      border-radius:18px;
      background:var(--green);
      color:white;
      font-weight:1000;
      letter-spacing:.18em;
      font-size:18px;
      cursor:pointer;
      margin-top:12px;
    }
    .secondaryBtn{
      width:100%;
      height:48px;
      border:1px solid rgba(220,228,214,.95);
      border-radius:18px;
      background:rgba(255,255,255,.75);
      color:var(--ink);
      font-weight:1000;
      letter-spacing:.12em;
      cursor:pointer;
      margin-top:10px;
    }

    /* day modal (åœ–7æ¦‚å¿µ) */
    .dayHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:0 0 10px;
    }
    .dayHeader .date{
      font-weight:1100;
      font-size:20px;
      letter-spacing:.06em;
      color:var(--ink);
    }
    .dayHeader .sum{
      color:var(--ink2);
      font-weight:1000;
      font-size:12px;
      letter-spacing:.06em;
      white-space:nowrap;
    }
    .dayList{
      display:grid;
      gap:10px;
      margin-top:8px;
    }
    .dayItem{
      background:rgba(223,231,211,.55);
      border:1px solid rgba(220,228,214,.95);
      border-radius:18px;
      padding:12px 12px;
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;
      align-items:center;
      cursor:pointer;
    }
    .dayItem .main{
      font-weight:1000;
      color:var(--ink);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .dayItem .sub{
      margin-top:6px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      color:var(--ink2);
      font-weight:1000;
      font-size:12px;
    }
    .pill{
      background:var(--pill);
      border:1px solid rgba(220,228,214,.95);
      color:var(--pillText);
      border-radius:999px;
      padding:6px 10px;
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
    }
    .pill.like{ color:var(--green); }
    .pill.dislike{ color:var(--red); }

    /* editor form */
    .formGrid{ display:grid; gap:10px; }
    .fieldRow{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .field{
      background:rgba(255,255,255,.78);
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px 12px;
    }
    .field label{
      font-weight:1000;
      letter-spacing:.12em;
      font-size:12px;
      color:var(--ink2);
      display:block;
      margin-bottom:8px;
    }
    .field .pick{
      border:1px solid rgba(220,228,214,.95);
      background:rgba(223,231,211,.55);
      padding:10px 12px;
      border-radius:14px;
      font-weight:1000;
      cursor:pointer;
      text-align:center;
      color:var(--ink);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .field input{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(220,228,214,.95);
      outline:none;
      font-weight:1000;
      font-size:14px;
      color:var(--ink);
      background:rgba(255,255,255,.9);
    }
    .segRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-start;
    }
    .seg{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(220,228,214,.95);
      background:rgba(255,255,255,.75);
      font-weight:1000;
      color:var(--ink2);
      cursor:pointer;
      user-select:none;
    }
    .seg.on{
      background:rgba(111,127,70,.18);
      border-color:rgba(111,127,70,.28);
      color:var(--ink);
    }
    .dangerRow{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .dangerBtn{
      flex:1;
      height:46px;
      border-radius:16px;
      border:1px solid rgba(215,170,170,.55);
      background:rgba(255,255,255,.72);
      color:var(--red);
      font-weight:1000;
      cursor:pointer;
    }

    /* store picker */
    .storeHeader{
      display:grid;
      grid-template-columns:1fr auto;
      align-items:center;
      gap:10px;
      margin-top:2px;
      margin-bottom:10px;
    }
    .storeHeader .title{
      text-align:center;
      font-weight:1100;
      font-size:20px;
      letter-spacing:.12em;
      color:var(--ink);
    }
    .storeHeader .manageBtn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.8);
      border-radius:999px;
      padding:8px 12px;
      font-weight:1000;
      color:var(--ink2);
      cursor:pointer;
    }
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center; /* ç½®ä¸­ */
      padding:6px 2px 8px;
    }
    .chip{
      border:1px solid rgba(220,228,214,.95);
      background:rgba(223,231,211,.7);
      color:var(--ink);
      border-radius:999px;
      padding:10px 14px;
      font-weight:1000;
      cursor:pointer;
      position:relative;
      min-width:74px;
      text-align:center;
    }
    .chip .del{
      display:none;
      position:absolute;
      top:-6px;
      right:-6px;
      width:22px;height:22px;
      border-radius:999px;
      background:rgba(255,255,255,.92);
      border:1px solid var(--line);
      color:var(--red);
      font-weight:1000;
      cursor:pointer;
      line-height:20px;
    }
    .chips.manage .chip .del{ display:block; }

    .addRow{
      margin-top:10px;
      border:2px solid rgba(220,228,214,.95);
      background:rgba(255,255,255,.65);
      border-radius:18px;
      padding:12px 12px;
      text-align:center;
      font-weight:1000;
      color:var(--ink2);
      cursor:pointer;
    }

    /* JS error overlay (é¿å…ç™½ç•«é¢ä½ æ‰¾ä¸åˆ°å…‡æ‰‹) */
    .jsErr{
      position:fixed;
      inset:0;
      background:radial-gradient(900px 500px at 50% 0%, #fff 0%, #f2f4ef 60%, #e9eee3 100%);
      display:none;
      z-index:999;
      padding:22px 16px;
    }
    .jsErr.show{ display:block; }
    .jsErr h2{
      margin:6px 0 12px;
      color:#b33;
      font-size:22px;
      font-weight:1100;
    }
    .jsErr pre{
      background:#fff;
      border:1px solid #f0c8c8;
      border-radius:16px;
      padding:14px;
      overflow:auto;
      white-space:pre-wrap;
      word-break:break-word;
      max-height:55vh;
      box-shadow:0 12px 26px rgba(0,0,0,.08);
      font-weight:900;
    }
    .jsErr .small{
      margin-top:10px;
      color:#888;
      font-weight:900;
    }

    /* å°è¢å¹•å†ç¸®ä¸€é»ï¼Œç¡¬å¡ä¸€é  */
    @media (max-height: 760px){
      .day{ height:48px; }
      .stats .statCard{ min-height:70px; }
      .monthLabel{ font-size:20px; }
      .titleRow h1{ font-size:19px; }
      .bottomWrap{ padding:9px 12px; }
      .actionBtn{ padding:11px 12px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="titleRow">
      <h1>ä¸€éš»è‚¥è±¬å˜‰çš„èª•ç”Ÿ</h1>
      <button class="quickAdd" id="openQuickAdd" title="æ–°å¢ï¼ˆä»Šå¤©ï¼‰">
        <!-- cup outline -->
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--ink)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M7 8h10v8a4 4 0 0 1-4 4h-2a4 4 0 0 1-4-4V8z"/>
          <path d="M17 10h2a2 2 0 0 1 0 4h-2"/>
          <path d="M9 6h6"/>
        </svg>
      </button>
    </div>

    <div class="stats">
      <div class="statCard year">
        <div class="strip"></div>
        <div class="cap">å¹´åº¦ç´¯è¨ˆ</div>
        <div class="val"><span id="yearCount">0</span><small>æ¯</small> <span id="yearMoney">$0</span></div>
      </div>
      <div class="statCard month">
        <div class="strip"></div>
        <div class="cap">æœ¬æœˆçµ±è¨ˆ</div>
        <div class="val"><span id="monthCount">0</span><small>æ¯</small> <span id="monthMoney">$0</span></div>
      </div>
    </div>

    <div class="monthNav">
      <button class="navBtn" id="prevMonth" aria-label="ä¸Šå€‹æœˆ">â€¹</button>
      <div class="monthLabel" id="monthLabel">2026.01</div>
      <button class="navBtn" id="nextMonth" aria-label="ä¸‹å€‹æœˆ">â€º</button>
      <button class="todayBtn" id="goToday">ä»Šå¤©</button>
    </div>

    <div class="calWrap">
      <div class="dow">
        <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
      </div>
      <div class="grid" id="grid"></div>
    </div>

    <div class="bottomWrap" id="bottomWrap">
      <div class="bottomTitle">æˆ‘æœ€å¸¸å–</div>
      <div class="topCards" id="topCards"></div>
      <div class="hint">é»å¡ç‰‡çœ‹æœ€å¸¸å–æ’å</div>
    </div>

    <div class="actions">
      <div class="actionBtn like" id="openLike">
        <!-- thumbs up outlineï¼ˆç©ºå¿ƒç·šæ¢ï¼‰ -->
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M14 9V5a3 3 0 0 0-6 0v4"/>
          <path d="M7 9h11a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-7"/>
          <path d="M7 9v10H4a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2h3z"/>
        </svg>
        è®šè®š (<span id="likeCount">0</span>)
      </div>
      <div class="actionBtn dislike" id="openDislike">
        <!-- thumbs down outlineï¼ˆç©ºå¿ƒç·šæ¢ï¼‰ -->
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M10 15v4a3 3 0 0 0 6 0v-4"/>
          <path d="M17 15H6a2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2h7"/>
          <path d="M17 15V5h3a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-3z"/>
        </svg>
        è¸©é›· (<span id="dislikeCount">0</span>)
      </div>
    </div>
  </div>

  <!-- Day overlayï¼ˆé»æ—¥æœŸæœƒé–‹é€™å€‹ï¼šåœ–7æ¦‚å¿µï¼‰ -->
  <div class="overlay" id="dayOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <button class="closeX" data-close="dayOverlay">Ã—</button>
      <div class="dayHeader">
        <div class="date" id="dayTitle">2026-01-01</div>
        <div class="sum" id="daySummary">0æ¯ Â· $0</div>
      </div>
      <button class="secondaryBtn" id="addFromDay">ï¼‹ æ–°å¢ä»Šå¤©ä¸€æ¯</button>
      <div class="dayList" id="dayList"></div>
      <button class="primaryBtn" data-close="dayOverlay">é—œé–‰</button>
    </div>
  </div>

  <!-- Record editor -->
  <div class="overlay" id="recordOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <button class="closeX" data-close="recordOverlay">Ã—</button>
      <h3>
        <!-- cup outline -->
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--ink)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M7 8h10v8a4 4 0 0 1-4 4h-2a4 4 0 0 1-4-4V8z"/>
          <path d="M17 10h2a2 2 0 0 1 0 4h-2"/>
          <path d="M9 6h6"/>
        </svg>
        <span id="recordTitle">æ–°å¢ç´€éŒ„</span>
      </h3>

      <div class="formGrid">
        <div class="fieldRow">
          <div class="field">
            <label>æ—¥æœŸ</label>
            <div class="pick" id="datePick">2026-01-01</div>
          </div>
          <div class="field">
            <label>é‡‘é¡</label>
            <input id="priceInput" type="number" inputmode="numeric" min="0" placeholder="0" />
          </div>
        </div>

        <div class="fieldRow">
          <div class="field">
            <label>åº—å®¶</label>
            <div class="pick" id="storePick">é¸æ“‡åº—å®¶</div>
          </div>
          <div class="field">
            <label>å“é …</label>
            <input id="itemInput" maxlength="45" placeholder="ä¾‹å¦‚ï¼šæ³¢éœ¸ç´…èŒ¶æ‹¿éµ" />
          </div>
        </div>

        <div class="field">
          <label>ç”œåº¦</label>
          <div class="segRow" id="sugarRow"></div>
        </div>
        <div class="field">
          <label>å†°é‡</label>
          <div class="segRow" id="iceRow"></div>
        </div>
      </div>

      <div class="dangerRow">
        <button class="dangerBtn" id="toggleTag">ğŸ‘/ğŸ‘ åˆ‡æ›</button>
        <button class="dangerBtn" id="deleteRecord">åˆªé™¤</button>
      </div>

      <button class="primaryBtn" id="saveRecord">å„²å­˜ç´€éŒ„</button>
    </div>
  </div>

  <!-- Store pickerï¼ˆé»åº—å®¶æ¬„ä½æ‰é–‹ï¼šåœ–6æ¦‚å¿µï¼‰ -->
  <div class="overlay" id="storeOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <button class="closeX" data-close="storeOverlay">Ã—</button>

      <div class="storeHeader">
        <div class="title">é¸æ“‡åº—å®¶</div>
        <button class="manageBtn" id="toggleManage">ç®¡ç†</button>
      </div>

      <div class="chips" id="storeChips"></div>

      <div class="addRow" id="openAddStore">ï¼‹ æ–°å¢åº—å®¶</div>

      <button class="primaryBtn" data-close="storeOverlay">é—œé–‰</button>
    </div>
  </div>

  <!-- Add storeï¼ˆè‡ªè¨‚é¢¨æ ¼ï¼Œä¸ç”¨ iOS alertï¼‰ -->
  <div class="overlay" id="addStoreOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <button class="closeX" data-close="addStoreOverlay">Ã—</button>
      <h3>
        <!-- signal-like iconï¼ˆç©ºå¿ƒç·šæ¢ï¼Œçµ±ä¸€é¢¨æ ¼ï¼‰ -->
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--ink)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M5 14a7 7 0 0 1 14 0"/>
          <path d="M8 14a4 4 0 0 1 8 0"/>
          <path d="M12 18h0"/>
        </svg>
        æ–°å¢åº—å®¶
      </h3>
      <div class="field">
        <label>åº—å®¶åç¨±</label>
        <input id="addStoreInput" maxlength="20" placeholder="ä¾‹å¦‚ï¼šæ¸…å¿ƒã€èŒ¶æ¹¯æœƒ" />
      </div>
      <div class="hint">æ‰“éŒ¯ä¹Ÿæ²’é—œä¿‚ï¼Œç­‰ç­‰å¯ä»¥å»ã€Œç®¡ç†ã€åˆªæ‰å®ƒ ğŸ˜</div>
      <div class="dangerRow">
        <button class="dangerBtn" data-close="addStoreOverlay">å–æ¶ˆ</button>
        <button class="dangerBtn" id="confirmAddStore">æ–°å¢</button>
      </div>
    </div>
  </div>

  <!-- Ranking / Like / Dislike list -->
  <div class="overlay" id="listOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <button class="closeX" data-close="listOverlay">Ã—</button>
      <h3 id="listTitle"></h3>
      <div class="dayList" id="listBody"></div>
      <button class="primaryBtn" data-close="listOverlay">é—œé–‰</button>
    </div>
  </div>

  <!-- JS error overlay -->
  <div class="jsErr" id="jsErr">
    <h2>JS Error</h2>
    <pre id="jsErrMsg"></pre>
    <div class="small">æŠŠä¸Šé¢çš„éŒ¯èª¤è¨Šæ¯æˆªåœ–ä¸Ÿæˆ‘ï¼Œæˆ‘å¯ä»¥ç²¾æº–æŠ“å‡¶æ‰‹ã€‚</div>
  </div>

<script>
(() => {
  "use strict";

  // ===== crash guardï¼ˆé¿å…ç™½ç•«é¢ï¼‰=====
  function showJSError(err){
    const box = document.getElementById("jsErr");
    const msg = document.getElementById("jsErrMsg");
    msg.textContent = String(err && (err.stack || err.message || err) || "Unknown error");
    box.classList.add("show");
  }
  window.addEventListener("error", (e) => showJSError(e.error || e.message));
  window.addEventListener("unhandledrejection", (e) => showJSError(e.reason));

  // ===== storageï¼ˆè³‡æ–™æœƒä¸€ç›´åœ¨ï¼šlocalStorageï¼‰=====
  const KEY = "drinklog_v3_state_stable";
  const defaultStores = ["äº”ååµ","å¯ä¸å¯","éº»å¤","å¾—æ­£","äº”æ¡è™Ÿ","é¶´èŒ¶æ¨“","è¿·å®¢å¤","å¤§è‹‘å­","è€è³´"];
  const sugarOptions = ["ç„¡ç³–","å¾®ç³–","åŠç³–","å°‘ç³–","å…¨ç³–","å›ºå®š"];
  const iceOptions = ["å»å†°","å¾®å†°","å°‘å†°","æ­£å¸¸","å¸¸æº«","æº«","ç†±","å›ºå®š"];
  const MAX_PER_DAY = 3;

  const pad = (n) => String(n).padStart(2,"0");
  const today = new Date();
  const fmtDate = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

  function safeParse(json, fallback){
    try{ return JSON.parse(json); }catch(_){ return fallback; }
  }
  function load(){
    const raw = localStorage.getItem(KEY);
    const st = raw ? safeParse(raw, null) : null;
    if(st && typeof st === "object"){
      st.records = Array.isArray(st.records) ? st.records : [];
      st.stores = Array.isArray(st.stores) ? st.stores : [...defaultStores];
      return st;
    }
    return { records: [], stores: [...defaultStores] };
  }
  let state = load();
  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  // ===== dom refs =====
  const grid = document.getElementById("grid");
  const monthLabel = document.getElementById("monthLabel");

  const yearCountEl = document.getElementById("yearCount");
  const yearMoneyEl = document.getElementById("yearMoney");
  const monthCountEl = document.getElementById("monthCount");
  const monthMoneyEl = document.getElementById("monthMoney");
  const likeCountEl = document.getElementById("likeCount");
  const dislikeCountEl = document.getElementById("dislikeCount");
  const topCardsEl = document.getElementById("topCards");

  // overlays
  const overlays = {
    dayOverlay: document.getElementById("dayOverlay"),
    recordOverlay: document.getElementById("recordOverlay"),
    storeOverlay: document.getElementById("storeOverlay"),
    addStoreOverlay: document.getElementById("addStoreOverlay"),
    listOverlay: document.getElementById("listOverlay"),
  };
  function open(id){ overlays[id].classList.add("show"); }
  function close(id){ overlays[id].classList.remove("show"); }

  // overlay close
  document.body.addEventListener("click", (e) => {
    const t = e.target;
    if(t && t.dataset && t.dataset.close){
      close(t.dataset.close);
    }
    if(t.classList && t.classList.contains("overlay")){
      t.classList.remove("show");
    }
  });

  // ===== calendar state =====
  let viewYear = today.getFullYear();
  let viewMonth = today.getMonth(); // 0-11
  let selectedDate = fmtDate(today);

  function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
  function firstDow(y,m){ return new Date(y, m, 1).getDay(); } // 0=Sun

  function sumByDate(dateStr){
    let count = 0, money = 0;
    for(const r of state.records){
      if(r.date === dateStr){
        count++;
        money += (r.price|0);
      }
    }
    return {count, money};
  }

  // ===== Day viewï¼ˆé»æ—¥æœŸä¸€å®šé–‹é€™å€‹ï¼Œæµç¨‹å›ºå®šï¼‰=====
  const dayTitle = document.getElementById("dayTitle");
  const daySummary = document.getElementById("daySummary");
  const dayList = document.getElementById("dayList");
  const addFromDay = document.getElementById("addFromDay");

  function renderDayModal(dateStr){
    selectedDate = dateStr;
    dayTitle.textContent = dateStr;

    const recs = state.records.filter(r => r.date === dateStr).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    const {count, money} = sumByDate(dateStr);
    daySummary.textContent = `${count}æ¯ Â· $${money}`;

    dayList.innerHTML = "";
    if(recs.length === 0){
      dayList.innerHTML = `<div class="hint">ä»Šå¤©é‚„æ²’å–ï½ä½ æ˜¯ä»™å¥³é‚„æ˜¯æ€æ¨£ ğŸ˜†</div>`;
    }else{
      for(const r of recs){
        const div = document.createElement("div");
        div.className = "dayItem";
        div.innerHTML = `
          <div>
            <div class="main">${escapeHtml(r.store)} - ${escapeHtml(r.item)}</div>
            <div class="sub">
              <span class="pill">${escapeHtml(r.sugar)}/${escapeHtml(r.ice)}</span>
              ${r.price ? `<span class="pill">$${r.price}</span>` : ``}
              ${r.tag==="like" ? `<span class="pill like">è®š</span>` : r.tag==="dislike" ? `<span class="pill dislike">é›·</span>` : ``}
            </div>
          </div>
          <div class="pill">ç·¨è¼¯</div>
        `;
        div.addEventListener("click", () => {
          openEditorForRecord(r);
        });
        dayList.appendChild(div);
      }
    }
  }

  addFromDay.addEventListener("click", () => {
    openEditorForDate(selectedDate);
  });

  // ===== Editor =====
  const recordTitle = document.getElementById("recordTitle");
  const datePick = document.getElementById("datePick");
  const priceInput = document.getElementById("priceInput");
  const storePick = document.getElementById("storePick");
  const itemInput = document.getElementById("itemInput");
  const sugarRow = document.getElementById("sugarRow");
  const iceRow = document.getElementById("iceRow");
  const saveRecordBtn = document.getElementById("saveRecord");
  const deleteRecordBtn = document.getElementById("deleteRecord");
  const toggleTagBtn = document.getElementById("toggleTag");

  let editingId = null;
  let currentTag = "normal"; // normal | like | dislike
  let currentSugar = "ç„¡ç³–";
  let currentIce = "å»å†°";
  let currentStore = "";

  function buildSegRow(container, options, getVal, setVal){
    container.innerHTML = "";
    options.forEach(opt => {
      const b = document.createElement("div");
      b.className = "seg" + (getVal()===opt ? " on" : "");
      b.textContent = opt;
      b.addEventListener("click", () => {
        setVal(opt);
        [...container.children].forEach(ch => ch.classList.remove("on"));
        b.classList.add("on");
      });
      container.appendChild(b);
    });
  }

  function tagCycle(tag){
    if(tag==="normal") return "like";
    if(tag==="like") return "dislike";
    return "normal";
  }
  function tagText(tag){
    return tag==="like" ? "ç›®å‰ï¼šè®šè®š" : tag==="dislike" ? "ç›®å‰ï¼šè¸©é›·" : "ç›®å‰ï¼šæ™®é€š";
  }

  toggleTagBtn.addEventListener("click", () => {
    currentTag = tagCycle(currentTag);
    toggleTagBtn.textContent = "ğŸ‘/ğŸ‘ åˆ‡æ›ï¼ˆ" + tagText(currentTag) + "ï¼‰";
  });

  function openEditorForDate(dateStr){
    editingId = null;
    currentTag = "normal";
    currentSugar = "ç„¡ç³–";
    currentIce = "å»å†°";
    currentStore = "";

    recordTitle.textContent = "æ–°å¢ç´€éŒ„";
    datePick.textContent = dateStr;
    priceInput.value = "";
    storePick.textContent = "é¸æ“‡åº—å®¶";
    itemInput.value = "";

    toggleTagBtn.textContent = "ğŸ‘/ğŸ‘ åˆ‡æ›ï¼ˆ" + tagText(currentTag) + "ï¼‰";
    deleteRecordBtn.style.display = "none";

    buildSegRow(sugarRow, sugarOptions, () => currentSugar, (v)=>currentSugar=v);
    buildSegRow(iceRow, iceOptions, () => currentIce, (v)=>currentIce=v);

    open("recordOverlay");
  }

  function openEditorForRecord(rec){
    editingId = rec.id;
    currentTag = rec.tag || "normal";
    currentSugar = rec.sugar || "ç„¡ç³–";
    currentIce = rec.ice || "å»å†°";
    currentStore = rec.store || "";

    recordTitle.textContent = "ç·¨è¼¯ç´€éŒ„";
    datePick.textContent = rec.date;
    priceInput.value = rec.price ?? "";
    storePick.textContent = rec.store || "é¸æ“‡åº—å®¶";
    itemInput.value = rec.item || "";

    toggleTagBtn.textContent = "ğŸ‘/ğŸ‘ åˆ‡æ›ï¼ˆ" + tagText(currentTag) + "ï¼‰";
    deleteRecordBtn.style.display = "block";

    buildSegRow(sugarRow, sugarOptions, () => currentSugar, (v)=>currentSugar=v);
    buildSegRow(iceRow, iceOptions, () => currentIce, (v)=>currentIce=v);

    open("recordOverlay");
  }

  function newId(){
    return "r_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  }

  function countNewAddsForDate(dateStr){
    return state.records.filter(r => r.date === dateStr).length;
  }

  function upsertRecord(){
    const date = datePick.textContent.trim();
    const store = (currentStore || "").trim();
    const item = itemInput.value.trim();
    const price = Number(priceInput.value || 0);

    if(!store){
      alert("è«‹å…ˆé¸æ“‡åº—å®¶ ğŸ™");
      return;
    }
    if(!item){
      alert("å“é …å…ˆå¯«ä¸€ä¸‹å•¦ï½ä¸ç„¶ä½ æ˜å¤©æœƒå¿˜ ğŸ˜†");
      return;
    }

    // æ¯å¤©æœ€å¤š 3 æ¯ï¼ˆæ–°å¢æ™‚æ‰æª¢æŸ¥ï¼›ç·¨è¼¯åŸæœ¬é‚£ç­†ä¸ç®—æ–°å¢ï¼‰
    if(!editingId){
      const cnt = countNewAddsForDate(date);
      if(cnt >= MAX_PER_DAY){
        alert(`ä¸€å¤©æœ€å¤š ${MAX_PER_DAY} æ¯å•¦ï½ä½ æ˜¯è¦æŠŠè‡ªå·±é†ƒæˆçç å— ğŸ˜†`);
        return;
      }
    }

    if(editingId){
      const idx = state.records.findIndex(r => r.id===editingId);
      if(idx>=0){
        state.records[idx] = {
          ...state.records[idx],
          date, store, item,
          sugar: currentSugar,
          ice: currentIce,
          price: Math.max(0, price|0),
          tag: currentTag
        };
      }
    }else{
      state.records.push({
        id:newId(),
        date, store, item,
        sugar: currentSugar,
        ice: currentIce,
        price: Math.max(0, price|0),
        tag: currentTag,
        createdAt: Date.now()
      });
    }

    save();
    close("recordOverlay");
    renderAll();
    // å›åˆ°ç•¶æ—¥é ï¼Œåˆ·æ–°
    renderDayModal(date);
    open("dayOverlay");
  }

  saveRecordBtn.addEventListener("click", upsertRecord);

  deleteRecordBtn.addEventListener("click", () => {
    if(!editingId) return;
    state.records = state.records.filter(r => r.id !== editingId);
    save();
    close("recordOverlay");
    renderAll();
    renderDayModal(selectedDate);
  });

  // Quick addï¼ˆä»Šå¤©ï¼‰
  document.getElementById("openQuickAdd").addEventListener("click", () => {
    renderDayModal(selectedDate);
    open("dayOverlay");
  });

  // ===== Store picker =====
  const storeChips = document.getElementById("storeChips");
  const toggleManageBtn = document.getElementById("toggleManage");
  const openAddStoreBtn = document.getElementById("openAddStore");
  const addStoreInput = document.getElementById("addStoreInput");
  const confirmAddStoreBtn = document.getElementById("confirmAddStore");

  let manageMode = false;

  function renderStores(){
    storeChips.innerHTML = "";
    storeChips.classList.toggle("manage", manageMode);

    state.stores.forEach((name) => {
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.textContent = name;

      const del = document.createElement("button");
      del.className = "del";
      del.type = "button";
      del.textContent = "Ã—";
      del.title = "åˆªé™¤åº—å®¶";
      del.addEventListener("click", (e) => {
        e.stopPropagation();
        state.stores = state.stores.filter(s => s !== name);
        if(currentStore === name){
          currentStore = "";
          storePick.textContent = "é¸æ“‡åº—å®¶";
        }
        save();
        renderStores();
      });
      chip.appendChild(del);

      chip.addEventListener("click", () => {
        if(manageMode) return;
        currentStore = name;
        storePick.textContent = name;
        close("storeOverlay");
      });

      storeChips.appendChild(chip);
    });
  }

  storePick.addEventListener("click", () => {
    manageMode = false;
    toggleManageBtn.textContent = "ç®¡ç†";
    renderStores();
    open("storeOverlay");
  });

  toggleManageBtn.addEventListener("click", () => {
    manageMode = !manageMode;
    toggleManageBtn.textContent = manageMode ? "å®Œæˆ" : "ç®¡ç†";
    renderStores();
  });

  openAddStoreBtn.addEventListener("click", () => {
    addStoreInput.value = "";
    open("addStoreOverlay");
  });

  confirmAddStoreBtn.addEventListener("click", () => {
    const name = addStoreInput.value.trim();
    if(!name){
      alert("åº—å®¶åç¨±ä¸èƒ½ç©ºç™½å•¦ï½");
      return;
    }
    if(state.stores.includes(name)){
      alert("é€™å®¶å·²ç¶“åœ¨æ¸…å–®è£¡äº† ğŸ˜†");
      return;
    }
    state.stores.push(name);
    save();
    close("addStoreOverlay");
    renderStores();
  });

  // ===== Calendar renderï¼ˆé»æ—¥æœŸ â†’ é–‹ dayOverlayï¼Œä¸æœƒè·‘å‡ºåº—å®¶é¸å–®ï¼‰=====
  function renderCalendar(){
    monthLabel.textContent = `${viewYear}.${pad(viewMonth+1)}`;
    grid.innerHTML = "";

    const totalDays = daysInMonth(viewYear, viewMonth);
    const start = firstDow(viewYear, viewMonth);

    for(let i=0;i<42;i++){
      const dayNum = i - start + 1;
      const cell = document.createElement("div");
      cell.className = "day";

      if(dayNum < 1 || dayNum > totalDays){
        cell.classList.add("muted");
        grid.appendChild(cell);
        continue;
      }

      const d = new Date(viewYear, viewMonth, dayNum);
      const dateStr = fmtDate(d);

      const dow = d.getDay();
      if(dow===0) cell.classList.add("sun");
      if(dow===6) cell.classList.add("sat");

      const {count, money} = sumByDate(dateStr);
      if(count>0) cell.classList.add("hasDrink");
      if(dateStr === selectedDate) cell.classList.add("selected");

      const num = document.createElement("div");
      num.className = "num";
      num.textContent = String(dayNum);

      const amt = document.createElement("div");
      amt.className = "amt";
      amt.textContent = money>0 ? `$${money}` : (count>0 ? "$0" : "");

      cell.appendChild(num);
      cell.appendChild(amt);

      cell.addEventListener("click", () => {
        selectedDate = dateStr;
        renderCalendar();
        renderDayModal(dateStr);
        open("dayOverlay");
      });

      grid.appendChild(cell);
    }
  }

  // ===== Stats =====
  function renderStats(){
    const y = viewYear;
    const ym = `${viewYear}-${pad(viewMonth+1)}`;

    let yc=0, ymoney=0;
    let mc=0, mmoney=0;
    let likeC=0, dislikeC=0;

    for(const r of state.records){
      if(!r || !r.date) continue;
      if(r.date.startsWith(String(y)+"-")){
        yc++;
        ymoney += (r.price|0);
      }
      if(r.date.startsWith(ym)){
        mc++;
        mmoney += (r.price|0);
      }
      if(r.tag==="like") likeC++;
      if(r.tag==="dislike") dislikeC++;
    }

    yearCountEl.textContent = yc;
    yearMoneyEl.textContent = "$" + ymoney;
    monthCountEl.textContent = mc;
    monthMoneyEl.textContent = "$" + mmoney;

    likeCountEl.textContent = likeC;
    dislikeCountEl.textContent = dislikeC;
  }

  // ===== Ranking (æˆ‘æœ€å¸¸å– TOP3 + æ’åæ¸…å–®) =====
  function keyOf(r){
    const s = (r.store||"").trim();
    const i = (r.item||"").trim();
    const su = (r.sugar||"").trim();
    const ic = (r.ice||"").trim();
    return `${s}|||${i}|||${su}|||${ic}`;
  }

  function computeRanking(){
    const map = new Map();
    for(const r of state.records){
      const k = keyOf(r);
      if(!k.includes("|||")) continue;
      const v = map.get(k) || { count:0, sample:r, latest:0 };
      v.count++;
      v.sample = r;
      v.latest = Math.max(v.latest, r.createdAt||0);
      map.set(k,v);
    }
    const arr = [...map.values()].map(v => ({
      count:v.count,
      store:v.sample.store,
      item:v.sample.item,
      sugar:v.sample.sugar,
      ice:v.sample.ice,
      latest:v.latest
    }));
    arr.sort((a,b)=> b.count-a.count || b.latest-a.latest);
    return arr;
  }

  function renderTop3(){
    const rank = computeRanking().slice(0,3);
    topCardsEl.innerHTML = "";

    for(let i=0;i<3;i++){
      const card = document.createElement("div");
      if(!rank[i]){
        card.className = "miniCard empty";
        card.innerHTML = `<div class="s">ï¼ˆå°šç„¡ï¼‰</div><div class="i">å»å–ä¸€æ¯å†å›ä¾† ğŸ˜†</div>`;
      }else{
        card.className = "miniCard";
        card.innerHTML = `
          <div class="s">${escapeHtml(rank[i].store)}</div>
          <div class="i">${escapeHtml(rank[i].item)}</div>
        `;
        card.addEventListener("click", openRankingList);
      }
      topCardsEl.appendChild(card);
    }
  }

  // list overlay
  const listTitle = document.getElementById("listTitle");
  const listBody = document.getElementById("listBody");

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function setListTitle(text, type){
    // çµ±ä¸€ã€Œç©ºå¿ƒç·šæ¢ã€iconï¼šrank ç”¨ signal-like
    const iconRank = `
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--ink)" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M5 14a7 7 0 0 1 14 0"/>
        <path d="M8 14a4 4 0 0 1 8 0"/>
        <path d="M12 18h0"/>
      </svg>`;
    const iconLike = `
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M14 9V5a3 3 0 0 0-6 0v4"/>
        <path d="M7 9h11a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-7"/>
        <path d="M7 9v10H4a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2h3z"/>
      </svg>`;
    const iconDislike = `
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M10 15v4a3 3 0 0 0 6 0v-4"/>
        <path d="M17 15H6a2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2h7"/>
        <path d="M17 15V5h3a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-3z"/>
      </svg>`;
    const icon = type==="like" ? iconLike : type==="dislike" ? iconDislike : iconRank;
    listTitle.innerHTML = icon + `<span>${escapeHtml(text)}</span>`;
  }

  function openRankingList(){
    const rank = computeRanking();
    setListTitle("æœ€å¸¸å–æ’å", "rank");
    listBody.innerHTML = "";

    if(rank.length===0){
      listBody.innerHTML = `<div class="hint">å°šç„¡è³‡æ–™</div>`;
      open("listOverlay");
      return;
    }

    rank.slice(0, 30).forEach(row => {
      const div = document.createElement("div");
      div.className = "dayItem";
      div.innerHTML = `
        <div>
          <div class="main">${escapeHtml(row.store)} - ${escapeHtml(row.item)}</div>
          <div class="sub">
            <span class="pill">${escapeHtml(row.sugar)}/${escapeHtml(row.ice)}</span>
          </div>
        </div>
        <div class="pill">${row.count}æ¬¡</div>
      `;
      listBody.appendChild(div);
    });

    open("listOverlay");
  }

  function openTagList(tag){
    const title = tag==="like" ? "è®šè®šæ¸…å–®" : "è¸©é›·æ¸…å–®";
    setListTitle(title, tag);

    const recs = state.records.filter(r => r.tag===tag);
    listBody.innerHTML = "";
    if(recs.length===0){
      listBody.innerHTML = `<div class="hint">å°šç„¡è³‡æ–™</div>`;
      open("listOverlay");
      return;
    }

    // group
    const map = new Map();
    for(const r of recs){
      const k = keyOf(r);
      const v = map.get(k) || { count:0, sample:r, latest:0 };
      v.count++;
      v.sample = r;
      v.latest = Math.max(v.latest, r.createdAt||0);
      map.set(k,v);
    }
    const arr = [...map.values()].map(v => ({
      count:v.count,
      store:v.sample.store,
      item:v.sample.item,
      sugar:v.sample.sugar,
      ice:v.sample.ice,
      latest:v.latest
    }));
    arr.sort((a,b)=> b.count-a.count || b.latest-a.latest);

    arr.slice(0, 30).forEach(row => {
      const div = document.createElement("div");
      div.className = "dayItem";
      div.innerHTML = `
        <div>
          <div class="main">${escapeHtml(row.store)} - ${escapeHtml(row.item)}</div>
          <div class="sub"><span class="pill">${escapeHtml(row.sugar)}/${escapeHtml(row.ice)}</span></div>
        </div>
        <div class="pill">${row.count}æ¬¡</div>
      `;
      listBody.appendChild(div);
    });

    open("listOverlay");
  }

  // actions
  document.getElementById("openLike").addEventListener("click", () => openTagList("like"));
  document.getElementById("openDislike").addEventListener("click", () => openTagList("dislike"));

  // bottom click -> ranking
  document.getElementById("bottomWrap").addEventListener("click", (e) => {
    if(e.target.closest(".miniCard")) return;
    openRankingList();
  });

  // nav
  document.getElementById("prevMonth").addEventListener("click", () => {
    viewMonth--;
    if(viewMonth<0){ viewMonth=11; viewYear--; }
    renderAll();
  });
  document.getElementById("nextMonth").addEventListener("click", () => {
    viewMonth++;
    if(viewMonth>11){ viewMonth=0; viewYear++; }
    renderAll();
  });
  document.getElementById("goToday").addEventListener("click", () => {
    viewYear = today.getFullYear();
    viewMonth = today.getMonth();
    selectedDate = fmtDate(today);
    renderAll();
  });

  // init
  function renderAll(){
    renderStats();
    renderCalendar();
    renderTop3();
  }

  // åˆå§‹é€²ä¾†å°±é¸ä»Šå¤©
  selectedDate = fmtDate(today);

  renderStores();
  renderAll();

})();
</script>
</body>
</html>