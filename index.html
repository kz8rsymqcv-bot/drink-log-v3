<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>飲料紀錄</title>

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="飲料紀錄" />

  <!-- iOS 主畫面 icon -->
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.PNG">
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">

  <!-- favicon -->
  <link rel="icon" type="image/png" href="./apple-touch-icon.PNG">
  <link rel="icon" type="image/png" href="./apple-touch-icon.png">

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');

    :root{
      --main:#8A9A5B;
      --main-dark:#556B2F;
      --bg:#F2F4EF;
      --weekend:#C08282;
      --today-border:#CFE0B8;

      --bad:#B56B6B;
      --year-accent:#CD5C5C;
      --month-accent:#8A9A5B;
    }

    html, body {
      height: 100%;
      background: var(--bg);
    }
    body{
      font-family:'Noto Sans TC', system-ui, -apple-system, "PingFang TC", "Heiti TC", sans-serif;
      -webkit-tap-highlight-color: transparent;
      background: var(--bg);
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      overscroll-behavior-y: none;
    }
    .no-scrollbar::-webkit-scrollbar{ display:none; }

    #app{ height: 100svh; }

    /* Calendar */
    .calendar-wrap{
      flex: 1 1 auto;
      min-height: 0;
      display:flex;
      flex-direction:column;
    }
    .calendar-grid{
      display:grid;
      grid-template-columns:repeat(7, minmax(0,1fr));
      gap: 10px;
      padding: 8px;
    }
    .day-cell{
      height: clamp(40px, 7.2vh, 56px);
      border-radius: 18px;
    }
    .today-ring{
      outline: 2px solid var(--today-border);
      outline-offset: -2px;
    }

    .modal-sheet{
      max-height: 85svh;
      overflow-y:auto;
      -webkit-overflow-scrolling: touch;
    }

    /* iOS 中文輸入：避免小字觸發縮放 + IME 卡住 */
    input, button{
      font-size: 16px;
    }

    /* Better wrapping for long text chips/list items */
    .wrap-anywhere{
      overflow-wrap:anywhere;
      word-break:break-word;
    }

    /* Debug overlay (if any error occurs, show message instead of silent white) */
    #fatalOverlay{
      display:none;
      position:fixed;
      inset:0;
      background:#F7F7F7;
      z-index:9999;
      padding:24px;
    }
    #fatalOverlay .box{
      max-width: 460px;
      margin: 0 auto;
      background:#fff;
      border-radius:24px;
      padding:18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
      border:1px solid rgba(0,0,0,.06);
    }
    #fatalOverlay pre{
      white-space:pre-wrap;
      overflow-wrap:anywhere;
      font-size:12px;
      background:#fafafa;
      border:1px solid rgba(0,0,0,.06);
      padding:12px;
      border-radius:14px;
      margin-top:10px;
    }
  </style>
</head>

<body>
  <div id="fatalOverlay">
    <div class="box">
      <div class="text-xl font-black text-red-600">JS Error</div>
      <div class="text-sm text-slate-600 mt-1">你遇到一個會導致白畫面的錯誤，但我把它攔下來了。</div>
      <pre id="fatalMsg"></pre>
      <div class="mt-3 flex gap-2">
        <button id="btnClearStorage" class="flex-1 py-3 rounded-xl bg-[var(--main-dark)] text-white font-black text-sm">清除資料並重整</button>
        <button id="btnReload" class="flex-1 py-3 rounded-xl bg-white border font-black text-sm text-slate-700">重整</button>
      </div>
      <div class="text-xs text-slate-400 mt-3">提示：常見原因是資料裡含有反斜線 \\ 或不正常字元。</div>
    </div>
  </div>

  <div id="app" class="max-w-md mx-auto px-4 flex flex-col overflow-hidden"></div>

  <script>
    (function(){
      "use strict";

      /********************
       * Global error guard (prevents silent white screen)
       ********************/
      function showFatal(err){
        try{
          const overlay = document.getElementById("fatalOverlay");
          const msg = document.getElementById("fatalMsg");
          if(msg) msg.textContent = String(err && (err.stack || err.message) || err);
          if(overlay) overlay.style.display = "block";
          const btn1 = document.getElementById("btnClearStorage");
          const btn2 = document.getElementById("btnReload");
          if(btn1) btn1.onclick = function(){ localStorage.clear(); location.reload(); };
          if(btn2) btn2.onclick = function(){ location.reload(); };
        }catch(e){
          // last resort
          alert("JS Error: " + (err && err.message ? err.message : err));
        }
      }
      window.addEventListener("error", function(e){ showFatal(e.error || e.message || e); });
      window.addEventListener("unhandledrejection", function(e){ showFatal(e.reason || e); });

      /********************
       * Storage Keys
       ********************/
      const KEY_TITLE = "fpj_app_title";
      const KEY_DATA  = "fpj_offline_data_v3";
      const KEY_SHOPS = "fpj_shop_list_v1";

      /********************
       * Options
       ********************/
      const iceOptions   = ["正常","少冰","微冰","去冰","常溫","溫","熱","固定"];
      const sugarOptions = ["全糖","少糖","半糖","微糖","一分","0.5分","無糖","固定"];

      const defaultShopList = ["五十嵐","可不可","麻古","得正","五桐號","鶴茶樓","迷客夏","大苑子"];

      /********************
       * Safe helpers (prevents backslash & weird chars causing issues)
       ********************/
      function safeText(s){
        // Remove backslashes and most control chars (keep newline/tab if you ever need)
        return String(s || "")
          .replace(/\\/g, "")               // remove \
          .replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F\u007F]/g, ""); // control chars
      }
      function escapeHtml(s){
        return String(s || "")
          .replace(/&/g,"&amp;")
          .replace(/</g,"&lt;")
          .replace(/>/g,"&gt;")
          .replace(/"/g,"&quot;")
          .replace(/'/g,"&#039;");
      }
      function safeParse(s){
        try{ return JSON.parse(s); }catch(e){ return null; }
      }

      /********************
       * State
       ********************/
      const today = new Date();
      let state = {
        currentDate: new Date(today.getFullYear(), today.getMonth(), 1),
        selectedDate: null,

        appTitle: safeText(localStorage.getItem(KEY_TITLE)) || "一隻肥豬嘉的誕生",
        isEditingTitle: false,

        records: safeParse(localStorage.getItem(KEY_DATA)) || {},

        shops: (() => {
          const fromStore = safeParse(localStorage.getItem(KEY_SHOPS));
          const arr = Array.isArray(fromStore) ? fromStore : defaultShopList.slice();
          // sanitize + unique + keep order
          const out = [];
          const seen = new Set();
          for(const x of arr){
            const t = safeText(x).trim();
            if(!t) continue;
            if(seen.has(t)) continue;
            seen.add(t);
            out.push(t);
          }
          return out.length ? out : defaultShopList.slice();
        })(),

        shopPicker: { open:false, idx:null, mode:"pick" }, // mode: pick | add | manage
      };

      function saveData(){ localStorage.setItem(KEY_DATA, JSON.stringify(state.records)); }
      function saveTitle(t){
        state.appTitle = safeText(t).trim();
        localStorage.setItem(KEY_TITLE, state.appTitle);
      }
      function saveShops(){
        localStorage.setItem(KEY_SHOPS, JSON.stringify(state.shops));
      }

      function formatDateKey(d){
        return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,'0') + "-" + String(d.getDate()).padStart(2,'0');
      }
      function sameDay(a,b){
        return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
      }
      function ensureDayArray(dateKey){
        if(!state.records[dateKey]) state.records[dateKey] = [];
        return state.records[dateKey];
      }
      function defaultDrink(){
        return { shop:"", item:"", ice:"去冰", sugar:"無糖", price:0, rating:null };
      }
      function drinkLabel(drink){
        const shop = safeText(drink.shop).trim();
        const item = safeText(drink.item).trim();
        const s = safeText(drink.sugar || "無糖");
        const i = safeText(drink.ice || "去冰");
        const base = (shop + (shop && item ? "-" : "") + item).trim() || "（未命名）";
        return base + "（" + s + "/" + i + "）";
      }

      /********************
       * Stats
       ********************/
      function calculateStats(){
        const y = state.currentDate.getFullYear();
        const m = state.currentDate.getMonth();

        let yTotal=0, yCount=0, mTotal=0, mCount=0;
        const comboFreq = {};
        const goodList = [];
        const badList  = [];

        const keys = Object.keys(state.records || {});
        for(const key of keys){
          const dt = new Date(key);
          if(isNaN(dt.getTime())) continue;

          const isYear  = dt.getFullYear() === y;
          const isMonth = isYear && dt.getMonth() === m;

          const arr = state.records[key] || [];
          for(const drink of arr){
            const price = Number(drink && drink.price || 0) || 0;

            if(isYear){ yTotal += price; yCount++; }
            if(isMonth){ mTotal += price; mCount++; }

            const shop = safeText(drink && drink.shop).trim();
            const item = safeText(drink && drink.item).trim();
            if(shop && item){
              const name = shop + "-" + item;
              comboFreq[name] = (comboFreq[name]||0) + 1;
            }
            if(drink && drink.rating === "good") goodList.push({drink, date:key});
            if(drink && drink.rating === "bad")  badList.push({drink, date:key});
          }
        }

        const topCombos = Object.entries(comboFreq)
          .sort((a,b)=>b[1]-a[1])
          .slice(0,10); // keep more for detail modal

        return { yTotal, yCount, mTotal, mCount, topCombos, goodList, badList };
      }

      /********************
       * Icons (hollow / outline)
       ********************/
      function thumbIcon(color){
        return (
          '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="'+color+'" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">' +
          '<path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3z"/>' +
          '<path d="M7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/>' +
          '</svg>'
        );
      }
      function thumbDownIcon(color){
        return (
          '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="'+color+'" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">' +
          '<path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3z"/>' +
          '<path d="M17 2h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2h-3"/>' +
          '</svg>'
        );
      }

      /********************
       * Render
       ********************/
      function render(){
        const app = document.getElementById("app");
        const stats = calculateStats();

        const year = state.currentDate.getFullYear();
        const month = state.currentDate.getMonth();
        const daysInMonth = new Date(year, month+1, 0).getDate();
        const firstDay = new Date(year, month, 1).getDay();

        // Title
        let titleHtml = "";
        if(state.isEditingTitle){
          titleHtml =
            '<input id="titleInput" type="text" class="text-xl font-black text-[var(--main)] text-center bg-white rounded-full px-4 py-2 border-2 border-[var(--main)] w-full max-w-[280px] outline-none" ' +
            'value="' + escapeHtml(state.appTitle) + '" />';
        }else{
          titleHtml =
            '<div id="titleDisplay" class="flex items-center gap-2 cursor-pointer active:opacity-60 select-none">' +
              '<h1 class="text-xl font-black tracking-widest text-[var(--main)]">'+ escapeHtml(state.appTitle) +'</h1>' +
              '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--main)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-50">' +
                '<path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>' +
              '</svg>' +
            '</div>';
        }

        // Calendar cells
        let calendarCells = "";
        for(let i=0;i<firstDay;i++) calendarCells += "<div></div>";

        for(let d=1; d<=daysInMonth; d++){
          const dateObj = new Date(year, month, d);
          const key = formatDateKey(dateObj);
          const list = state.records[key] || [];
          const count = list.length;
          const isWeekend = ((firstDay + d - 1) % 7 === 0) || ((firstDay + d - 1) % 7 === 6);
          const isToday = sameDay(dateObj, today);

          let bgClass = "bg-white/40";
          if(count===1) bgClass = "bg-[#E1EAD1]";
          if(count===2) bgClass = "bg-[#FEF5D4]";
          if(count>=3) bgClass = "bg-[#FEE2E2]";

          const daySum = count>0 ? list.reduce((s,i)=>s+Number((i&&i.price)||0),0) : 0;

          calendarCells +=
            '<button data-day="'+d+'" class="day-cell '+bgClass+' '+(isToday ? "today-ring" : "")+
              ' w-full flex flex-col items-center justify-center border border-white/60 shadow-sm active:scale-95 transition-transform relative">' +
              '<span class="text-[12px] font-black" style="color:'+(isWeekend ? "var(--weekend)" : "var(--main-dark)")+'">'+d+'</span>' +
              (count>0 ? '<span class="text-[9px] font-bold text-slate-400 leading-none mt-0.5">$'+daySum+'</span>' : "") +
            '</button>';
        }

        const goodCount = stats.goodList.length;
        const badCount  = stats.badList.length;

        // Top combo preview (show only first; click for full list)
        const topPreview = stats.topCombos.length ? stats.topCombos[0] : null;

        app.innerHTML =
        '<!-- Header -->' +
        '<div class="flex justify-center items-center pt-4 pb-3 shrink-0">' + titleHtml + '</div>' +

        '<!-- Stats -->' +
        '<div class="grid grid-cols-2 gap-3 mb-3 shrink-0">' +

          // Year card
          '<div class="bg-white/80 p-3 rounded-[1.5rem] shadow-sm border border-white text-center relative overflow-hidden">' +
            '<div class="absolute top-0 left-0 w-full h-5 bg-[rgba(205,92,92,0.12)]"></div>' + /* pale red block */
            '<div class="absolute top-0 left-0 w-full h-1 bg-[#CD5C5C]/20"></div>' +
            '<p class="text-[10px] font-black text-[#CD5C5C] mb-1 tracking-widest relative">年度累計</p>' +
            '<p class="text-sm font-black text-slate-700 relative">' +
              stats.yCount + ' <span class="text-[10px] text-slate-400">杯</span>' +
              '<span class="text-[#CD5C5C] ml-1">$'+ Number(stats.yTotal||0).toLocaleString() +'</span>' +
            '</p>' +
          '</div>' +

          // Month card (add pale green block + top line)
          '<div class="bg-white/80 p-3 rounded-[1.5rem] shadow-sm border border-white text-center relative overflow-hidden">' +
            '<div class="absolute top-0 left-0 w-full h-5 bg-[rgba(138,154,91,0.14)]"></div>' + /* pale green block */
            '<div class="absolute top-0 left-0 w-full h-1 bg-[var(--main)]/20"></div>' +
            '<p class="text-[10px] font-black text-[var(--main)] mb-1 tracking-widest relative">本月統計</p>' +
            '<p class="text-sm font-black text-slate-700 relative">' +
              stats.mCount + ' <span class="text-[10px] text-slate-400">杯</span>' +
              '<span class="text-[var(--main-dark)] ml-1">$'+ Number(stats.mTotal||0).toLocaleString() +'</span>' +
            '</p>' +
          '</div>' +
        '</div>' +

        '<!-- Month Selector -->' +
        '<div class="flex justify-center mb-3 shrink-0">' +
          '<div class="flex items-center gap-6 bg-white/60 px-6 py-2 rounded-full border border-white/40 shadow-sm">' +
            '<button id="prevMonth" class="text-[var(--main)] font-black text-lg active:scale-75 transition-transform">〈</button>' +
            '<p class="font-black text-base tracking-tighter text-[var(--main-dark)] min-w-[88px] text-center">' +
              year + '.' + String(month+1).padStart(2,'0') +
            '</p>' +
            '<button id="nextMonth" class="text-[var(--main)] font-black text-lg active:scale-75 transition-transform">〉</button>' +
            '<button id="goToday" class="ml-1 px-3 py-1.5 rounded-full bg-white/70 border border-white/60 text-[11px] font-black text-[var(--main-dark)] active:scale-95 transition-transform">今天</button>' +
          '</div>' +
        '</div>' +

        '<!-- Calendar -->' +
        '<div class="calendar-wrap bg-white/95 rounded-[2rem] shadow-sm border border-white mb-3 overflow-hidden">' +
          '<div class="grid grid-cols-7 px-4 pt-4 pb-1 text-center shrink-0">' +
            ['日','一','二','三','四','五','六'].map(function(d,i){
              return '<div class="text-[10px] font-black" style="color:'+((i===0||i===6) ? "var(--weekend)" : "#A5B997")+'">'+d+'</div>';
            }).join('') +
          '</div>' +
          '<div class="calendar-grid flex-1 min-h-0">' + calendarCells + '</div>' +
        '</div>' +

        '<!-- Bottom -->' +
        '<div class="shrink-0 space-y-3 pb-3">' +

          '<!-- Top combos -->' +
          '<button id="openTopModal" class="w-full bg-white/70 px-4 py-3 rounded-[1.5rem] border border-white shadow-sm flex items-center gap-3 active:scale-[0.99] transition-transform">' +
            '<div class="bg-[var(--main)] text-white w-11 h-11 rounded-full flex flex-col items-center justify-center shadow-sm shrink-0">' +
              '<span class="text-[12px] font-black">TOP</span>' +
            '</div>' +
            '<div class="flex-1 text-left">' +
              (topPreview
                ? ('<div class="text-[12px] font-black text-[var(--main-dark)] wrap-anywhere leading-snug">' + escapeHtml(topPreview[0]) + '</div>' +
                   '<div class="text-[10px] font-bold text-slate-300 mt-0.5">' + topPreview[1] + ' 次（點我看更多）</div>')
                : '<span class="text-[10px] text-slate-400 italic">尚未產生排名...</span>') +
            '</div>' +
          '</button>' +

          '<!-- Good/Bad -->' +
          '<div class="grid grid-cols-2 gap-3">' +
            '<button id="openGood" class="bg-white/70 py-4 rounded-[1.2rem] border border-white flex items-center justify-center gap-2 text-[12px] font-black shadow-sm active:scale-95 transition-transform text-[var(--main-dark)]">' +
              thumbIcon("var(--main-dark)") +
              '<span>讚讚 ('+ goodCount +')</span>' +
            '</button>' +
            '<button id="openBad" class="bg-white/70 py-4 rounded-[1.2rem] border border-white flex items-center justify-center gap-2 text-[12px] font-black shadow-sm active:scale-95 transition-transform text-[var(--bad)]">' +
              thumbDownIcon("var(--bad)") +
              '<span>踩雷 ('+ badCount +')</span>' +
            '</button>' +
          '</div>' +

        '</div>';

        wireMainEvents();

        if(state.isEditingTitle){
          const input = document.getElementById("titleInput");
          if(input){
            input.focus();
            input.addEventListener("blur", function(){
              const v = (input.value||"").trim();
              if(v) saveTitle(v);
              state.isEditingTitle = false;
              render();
            }, { once:true });
          }
        }
      }

      /********************
       * Main Events
       ********************/
      function wireMainEvents(){
        const titleDisplay = document.getElementById("titleDisplay");
        if(titleDisplay){
          titleDisplay.onclick = function(){
            state.isEditingTitle = true;
            render();
          };
        }

        const prev = document.getElementById("prevMonth");
        const next = document.getElementById("nextMonth");
        const goToday = document.getElementById("goToday");

        if(prev) prev.onclick = function(){
          state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth()-1, 1);
          render();
        };
        if(next) next.onclick = function(){
          state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth()+1, 1);
          render();
        };
        if(goToday) goToday.onclick = function(){
          state.currentDate = new Date(today.getFullYear(), today.getMonth(), 1);
          render();
        };

        document.querySelectorAll("[data-day]").forEach(function(btn){
          btn.addEventListener("click", function(){
            const day = Number(btn.getAttribute("data-day"));
            openEditModal(day);
          });
        });

        const openGood = document.getElementById("openGood");
        const openBad  = document.getElementById("openBad");
        const openTop  = document.getElementById("openTopModal");

        if(openGood) openGood.onclick = function(){ openListModal("good"); };
        if(openBad)  openBad.onclick  = function(){ openListModal("bad"); };
        if(openTop)  openTop.onclick  = function(){ openTopModal(); };
      }

      /********************
       * Top modal
       ********************/
      function openTopModal(){
        const stats = calculateStats();
        const list = stats.topCombos || [];

        const items = list.length
          ? list.map(function(pair){
              const combo = pair[0];
              const count = pair[1];
              return (
                '<div class="flex justify-between gap-3 p-3 bg-[#F2F4EF] rounded-xl text-xs font-black">' +
                  '<div class="flex-1 wrap-anywhere leading-snug text-[var(--main-dark)]">'+ escapeHtml(combo) +'</div>' +
                  '<div class="opacity-50 shrink-0">'+ count +' 次</div>' +
                '</div>'
              );
            }).join("")
          : '<p class="text-center text-xs text-slate-300 py-6">尚無資料</p>';

        openCenterModal({
          titleHtml:
            '<div class="flex items-center justify-center gap-2">' +
              '<span class="inline-flex items-center justify-center w-6 h-6 rounded-full border-2 border-[var(--main-dark)]">' +
                '<span class="text-[10px] font-black text-[var(--main-dark)]">TOP</span>' +
              '</span>' +
              '<span class="font-black text-[var(--main-dark)]">最常喝排名</span>' +
            '</div>',
          bodyHtml:
            '<div class="max-h-72 overflow-y-auto space-y-2 no-scrollbar">' + items + '</div>',
          closeText: "關閉"
        });
      }

      /********************
       * Edit Modal
       ********************/
      function openEditModal(day){
        state.selectedDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), day);
        const dateKey = formatDateKey(state.selectedDate);
        ensureDayArray(dateKey);

        const modal = document.createElement("div");
        modal.id = "editModal";
        modal.className = "fixed inset-0 bg-[var(--main-dark)]/40 backdrop-blur-md z-[100] flex items-end";
        modal.innerHTML =
          '<div class="modal-sheet bg-[#FAFBF9] w-full rounded-t-[2.5rem] p-6 pb-10 shadow-2xl no-scrollbar">' +
            '<div class="flex justify-between items-center mb-5">' +
              '<h3 class="text-xl font-black text-[var(--main-dark)]">'+ (state.selectedDate.getMonth()+1) +'月'+ state.selectedDate.getDate() +'日</h3>' +
              '<button id="closeEdit" class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm text-slate-300 text-lg">✕</button>' +
            '</div>' +
            '<div id="drinkList" class="space-y-4"></div>' +
            '<button id="saveClose" class="w-full mt-6 py-4 bg-[var(--main-dark)] text-white rounded-[1.5rem] font-black text-base shadow-xl active:scale-95 transition-transform">儲存紀錄</button>' +
          '</div>';

        const old = document.getElementById("editModal");
        if(old) old.remove();

        document.body.appendChild(modal);

        const close1 = document.getElementById("closeEdit");
        const close2 = document.getElementById("saveClose");
        if(close1) close1.onclick = closeEditModal;
        if(close2) close2.onclick = closeEditModal;

        renderDrinkCards();
      }

      function closeEditModal(){
        const m = document.getElementById("editModal");
        if(m) m.remove();
        render();
      }

      function renderDrinkCards(){
        const dateKey = formatDateKey(state.selectedDate);
        const list = ensureDayArray(dateKey);

        const container = document.getElementById("drinkList");
        if(!container) return;
        container.innerHTML = "";

        for(let idx=0; idx<3; idx++){
          const drink = list[idx];
          const exists = !!drink;

          const prev = list[idx-1];
          const prevHasSomething = prev && (safeText(prev.item).trim() !== "" || safeText(prev.shop).trim() !== "");

          const canShow = (idx===0) || prevHasSomething || exists;
          if(!canShow) continue;

          if(!exists){
            const add = document.createElement("div");
            add.className = "p-5 rounded-[2rem] bg-[#F2F4EF] border-2 border-dashed border-[#DDE4D1]";
            add.innerHTML =
              '<button class="w-full py-4 text-[#A5B997] font-black text-xs flex flex-col items-center gap-1 active:opacity-60">' +
                '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M12 5v14M5 12h14"/></svg>' +
                '新增第 '+ (idx+1) +' 杯' +
              '</button>';

            add.querySelector("button").onclick = function(){
              while(list.length <= idx) list.push(defaultDrink());
              saveData();
              renderDrinkCards();
              setTimeout(function(){
                const el = document.querySelector('[data-field="shop"][data-idx="'+idx+'"]');
                if(el) el.focus();
              }, 50);
            };

            container.appendChild(add);
            continue;
          }

          // sanitize stored fields to avoid later explosions
          drink.shop  = safeText(drink.shop);
          drink.item  = safeText(drink.item);
          drink.ice   = safeText(drink.ice);
          drink.sugar = safeText(drink.sugar);

          const card = document.createElement("div");
          card.className = "p-5 rounded-[2rem] bg-white shadow-sm border border-white space-y-3";
          card.innerHTML =
            '<div class="flex justify-between items-center">' +
              '<span class="bg-[var(--main)] text-white px-3 py-1 rounded-full text-[10px] font-black tracking-widest">NO.'+ (idx+1) +'</span>' +
              '<div class="flex gap-2 items-center">' +
                '<button class="p-2 rounded-lg '+(drink.rating==="good" ? 'bg-[#E1EAD1] text-[var(--main-dark)]' : 'text-slate-300')+'" data-action="good" data-idx="'+idx+'">'+
                  thumbIcon("currentColor") +
                '</button>' +
                '<button class="p-2 rounded-lg '+(drink.rating==="bad" ? 'bg-[#FEE2E2] text-[var(--bad)]' : 'text-slate-300')+'" data-action="bad" data-idx="'+idx+'">'+
                  thumbDownIcon("currentColor") +
                '</button>' +
                '<button class="text-slate-200 ml-1" data-action="del" data-idx="'+idx+'">' +
                  '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">' +
                    '<path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>' +
                    '<path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>' +
                  '</svg>' +
                '</button>' +
              '</div>' +
            '</div>' +

            '<div class="grid grid-cols-2 gap-2">' +
              // Shop input: tap opens picker
              '<input type="text" inputmode="text" autocomplete="off" autocapitalize="off" readonly ' +
                'class="bg-[#F2F4EF] p-3 rounded-xl text-xs font-bold w-full border-none outline-none focus:ring-1 focus:ring-[var(--main)]" ' +
                'placeholder="店家" data-field="shop" data-idx="'+idx+'" value="'+ escapeHtml(drink.shop || "") +'" />' +

              '<input type="text" inputmode="text" autocomplete="off" autocapitalize="off" ' +
                'class="bg-[#F2F4EF] p-3 rounded-xl text-xs font-bold w-full border-none outline-none focus:ring-1 focus:ring-[var(--main)]" ' +
                'placeholder="品項" data-field="item" data-idx="'+idx+'" value="'+ escapeHtml(drink.item || "") +'" />' +
            '</div>' +

            '<div class="space-y-1">' +
              '<p class="text-[10px] font-black text-[#A5B997] ml-1">甜度</p>' +
              '<div class="flex flex-wrap gap-1.5">' +
                sugarOptions.map(function(opt){
                  const active = (drink.sugar===opt);
                  return '<button data-field="sugar" data-idx="'+idx+'" data-val="'+escapeHtml(opt)+'" ' +
                         'class="px-2.5 py-1.5 rounded-lg text-[10px] font-black transition-colors ' +
                         (active ? 'bg-[var(--main)] text-white shadow-sm' : 'bg-[#F2F4EF] text-[#A5B997]') + '">' +
                         escapeHtml(opt) + '</button>';
                }).join("") +
              '</div>' +
            '</div>' +

            '<div class="space-y-1">' +
              '<p class="text-[10px] font-black text-[#A5B997] ml-1">冰量</p>' +
              '<div class="flex flex-wrap gap-1.5">' +
                iceOptions.map(function(opt){
                  const active = (drink.ice===opt);
                  return '<button data-field="ice" data-idx="'+idx+'" data-val="'+escapeHtml(opt)+'" ' +
                         'class="px-2.5 py-1.5 rounded-lg text-[10px] font-black transition-colors ' +
                         (active ? 'bg-[var(--main)] text-white shadow-sm' : 'bg-[#F2F4EF] text-[#A5B997]') + '">' +
                         escapeHtml(opt) + '</button>';
                }).join("") +
              '</div>' +
            '</div>' +

            '<div class="relative pt-2">' +
              '<span class="absolute left-3 top-5 text-[var(--main)] font-black text-xs">$</span>' +
              '<input type="number" inputmode="decimal" ' +
                'class="w-full bg-[#F2F4EF] pl-8 p-3 rounded-xl text-sm font-black border-none outline-none focus:ring-1 focus:ring-[var(--main)]" ' +
                'placeholder="金額" data-field="price" data-idx="'+idx+'" value="'+ escapeHtml(String(drink.price||"")) +'" />' +
            '</div>';

          container.appendChild(card);
        }

        wireModalEvents();
      }

      function wireModalEvents(){
        const modal = document.getElementById("editModal");
        if(!modal) return;

        const dateKey = formatDateKey(state.selectedDate);
        const list = ensureDayArray(dateKey);

        // actions
        modal.querySelectorAll("[data-action]").forEach(function(btn){
          btn.onclick = function(){
            const idx = Number(btn.getAttribute("data-idx"));
            const act = btn.getAttribute("data-action");
            if(!list[idx]) return;

            if(act==="good"){
              list[idx].rating = (list[idx].rating==="good") ? null : "good";
              saveData();
              renderDrinkCards();
              return;
            }
            if(act==="bad"){
              list[idx].rating = (list[idx].rating==="bad") ? null : "bad";
              saveData();
              renderDrinkCards();
              return;
            }
            if(act==="del"){
              list.splice(idx,1);
              if(list.length===0) delete state.records[dateKey];
              saveData();
              renderDrinkCards();
              return;
            }
          };
        });

        // sugar/ice
        modal.querySelectorAll("button[data-field='sugar'], button[data-field='ice']").forEach(function(btn){
          btn.onclick = function(){
            const idx = Number(btn.getAttribute("data-idx"));
            const field = btn.getAttribute("data-field");
            const val = safeText(btn.getAttribute("data-val"));
            if(!list[idx]) return;
            list[idx][field] = val;
            saveData();
            renderDrinkCards();
          };
        });

        // shop picker open
        modal.querySelectorAll("input[data-field='shop']").forEach(function(inp){
          inp.onclick = function(){
            const idx = Number(inp.getAttribute("data-idx"));
            openShopPicker(idx);
          };
        });

        // inputs (IME-safe)
        modal.querySelectorAll("input[data-field='item'], input[data-field='price']").forEach(function(inp){
          const idx = Number(inp.getAttribute("data-idx"));
          const field = inp.getAttribute("data-field");
          let composing = false;

          inp.addEventListener("compositionstart", function(){ composing = true; });
          inp.addEventListener("compositionend", function(e){
            composing = false;
            applyValue(e.target.value);
          });

          inp.addEventListener("input", function(e){
            if(composing) return;
            applyValue(e.target.value);
          });

          function applyValue(raw){
            if(!list[idx]) return;

            if(field === "price"){
              list[idx].price = raw === "" ? 0 : (Number(raw) || 0);
            }else{
              list[idx][field] = safeText(raw);
            }
            saveData();

            // make add-next-cup appear
            if(field==="item" && idx===0){
              renderDrinkCards();
              setTimeout(function(){
                const again = document.querySelector('input[data-field="'+field+'"][data-idx="'+idx+'"]');
                if(again){
                  const pos = again.value.length;
                  again.focus();
                  try{ again.setSelectionRange(pos,pos); }catch(e){}
                }
              }, 0);
            }
          }
        });
      }

      /********************
       * Shop Picker + Add + Manage/Delete
       ********************/
      function openShopPicker(idx){
        state.shopPicker.open = true;
        state.shopPicker.idx = idx;
        state.shopPicker.mode = "pick";
        renderShopPicker();
      }

      function renderShopPicker(){
        // remove existing
        const old = document.getElementById("shopModal");
        if(old) old.remove();

        if(!state.shopPicker.open) return;

        const modal = document.createElement("div");
        modal.id = "shopModal";
        modal.className = "fixed inset-0 bg-black/60 backdrop-blur-md z-[120] flex items-center justify-center p-8";

        const chips = state.shops.map(function(name){
          const t = safeText(name).trim();
          return (
            '<button class="px-4 py-2 rounded-full bg-[#F2F4EF] text-[var(--main-dark)] font-black text-sm active:scale-95 transition-transform border border-white/60 shadow-sm" ' +
              'data-shop="'+ escapeHtml(t) +'">'+ escapeHtml(t) +'</button>'
          );
        }).join("");

        modal.innerHTML =
          '<div class="bg-white w-full rounded-[2.5rem] p-6 shadow-2xl" style="max-width:420px;">' +
            '<h3 class="text-center font-black mb-4 text-[var(--main-dark)]">選擇店家</h3>' +
            '<div class="flex flex-wrap gap-3 justify-center mb-4">' + chips + '</div>' +

            '<div class="grid grid-cols-2 gap-3">' +
              '<button id="btnAddShop" class="py-3 rounded-xl bg-white border font-black text-sm text-[var(--main-dark)] active:scale-95">＋ 新增店家</button>' +
              '<button id="btnManageShop" class="py-3 rounded-xl bg-white border font-black text-sm text-slate-600 active:scale-95">管理/刪除</button>' +
            '</div>' +

            '<button id="closeShop" class="w-full mt-4 py-3 bg-[var(--main-dark)] text-white rounded-xl font-black">關閉</button>' +
          '</div>';

        document.body.appendChild(modal);

        // choose shop
        modal.querySelectorAll("[data-shop]").forEach(function(btn){
          btn.onclick = function(){
            const shop = safeText(btn.getAttribute("data-shop"));
            applyShopToCurrentDrink(shop);
            closeShopPicker();
          };
        });

        const c1 = document.getElementById("closeShop");
        const a1 = document.getElementById("btnAddShop");
        const m1 = document.getElementById("btnManageShop");

        if(c1) c1.onclick = closeShopPicker;
        if(a1) a1.onclick = function(){ openAddShopModal(); };
        if(m1) m1.onclick = function(){ openManageShopModal(); };

        modal.addEventListener("click", function(e){
          if(e.target && e.target.id==="shopModal") closeShopPicker();
        });
      }

      function closeShopPicker(){
        state.shopPicker.open = false;
        state.shopPicker.idx = null;
        const m = document.getElementById("shopModal");
        if(m) m.remove();
      }

      function applyShopToCurrentDrink(shop){
        const editModal = document.getElementById("editModal");
        if(!editModal) return;

        const dateKey = formatDateKey(state.selectedDate);
        const list = ensureDayArray(dateKey);

        const idx = state.shopPicker.idx;
        if(idx==null || !list[idx]) return;

        list[idx].shop = safeText(shop).trim();
        saveData();
        renderDrinkCards();
      }

      function openAddShopModal(){
        const old = document.getElementById("shopAddModal");
        if(old) old.remove();

        const modal = document.createElement("div");
        modal.id = "shopAddModal";
        modal.className = "fixed inset-0 bg-black/60 backdrop-blur-md z-[130] flex items-center justify-center p-8";
        modal.innerHTML =
          '<div class="bg-white w-full rounded-[2.5rem] p-6 shadow-2xl" style="max-width:420px;">' +
            '<h3 class="text-center font-black mb-4 text-[var(--main-dark)]">新增店家</h3>' +
            '<input id="newShopInput" type="text" class="w-full bg-[#F2F4EF] p-3 rounded-xl font-black text-sm outline-none focus:ring-1 focus:ring-[var(--main)]" placeholder="輸入店家名稱" />' +
            '<div class="grid grid-cols-2 gap-3 mt-4">' +
              '<button id="cancelAddShop" class="py-3 rounded-xl bg-white border font-black text-sm text-slate-600 active:scale-95">取消</button>' +
              '<button id="confirmAddShop" class="py-3 rounded-xl bg-[var(--main-dark)] text-white font-black text-sm active:scale-95">新增</button>' +
            '</div>' +
          '</div>';
        document.body.appendChild(modal);

        const input = document.getElementById("newShopInput");
        if(input) input.focus();

        const cancel = document.getElementById("cancelAddShop");
        const ok = document.getElementById("confirmAddShop");

        if(cancel) cancel.onclick = function(){ modal.remove(); };
        if(ok) ok.onclick = function(){
          const val = input ? safeText(input.value).trim() : "";
          if(!val) return;
          // add unique
          if(!state.shops.includes(val)){
            state.shops.push(val);
            saveShops();
          }
          modal.remove();
          // re-render picker to show new shop
          renderShopPicker();
        };

        modal.addEventListener("click", function(e){
          if(e.target && e.target.id==="shopAddModal") modal.remove();
        });
      }

      function openManageShopModal(){
        const old = document.getElementById("shopManageModal");
        if(old) old.remove();

        // allow delete any shop (including defaults) — safer for typo fixes
        const items = state.shops.map(function(name, i){
          const t = safeText(name).trim();
          return (
            '<div class="flex items-center justify-between gap-3 p-3 bg-[#F2F4EF] rounded-xl">' +
              '<div class="flex-1 font-black text-sm text-[var(--main-dark)] wrap-anywhere">'+ escapeHtml(t) +'</div>' +
              '<button data-del="'+ i +'" class="px-3 py-2 rounded-lg bg-white border font-black text-xs text-[var(--bad)] active:scale-95">刪除</button>' +
            '</div>'
          );
        }).join("");

        const modal = document.createElement("div");
        modal.id = "shopManageModal";
        modal.className = "fixed inset-0 bg-black/60 backdrop-blur-md z-[140] flex items-center justify-center p-8";
        modal.innerHTML =
          '<div class="bg-white w-full rounded-[2.5rem] p-6 shadow-2xl" style="max-width:420px;">' +
            '<h3 class="text-center font-black mb-4 text-[var(--main-dark)]">管理店家（可刪除修正打錯）</h3>' +
            '<div class="max-h-72 overflow-y-auto space-y-2 no-scrollbar">' +
              (items || '<p class="text-center text-xs text-slate-300 py-6">尚無資料</p>') +
            '</div>' +
            '<button id="closeManageShop" class="w-full mt-4 py-3 bg-[var(--main-dark)] text-white rounded-xl font-black">關閉</button>' +
          '</div>';

        document.body.appendChild(modal);

        modal.querySelectorAll("[data-del]").forEach(function(btn){
          btn.onclick = function(){
            const idx = Number(btn.getAttribute("data-del"));
            if(isNaN(idx)) return;
            state.shops.splice(idx, 1);
            if(!state.shops.length) state.shops = defaultShopList.slice();
            saveShops();
            modal.remove();
            renderShopPicker(); // refresh picker list
            openManageShopModal(); // reopen updated list
          };
        });

        const close = document.getElementById("closeManageShop");
        if(close) close.onclick = function(){ modal.remove(); };

        modal.addEventListener("click", function(e){
          if(e.target && e.target.id==="shopManageModal") modal.remove();
        });
      }

      /********************
       * List modal (Good/Bad) — wrap long text, hollow icons, show full label
       ********************/
      function openListModal(type){
        const stats = calculateStats();
        const list = (type==="good") ? stats.goodList : stats.badList;

        const isGood = type==="good";
        const titleColor = isGood ? "var(--main-dark)" : "var(--bad)";
        const icon = isGood ? thumbIcon(titleColor) : thumbDownIcon(titleColor);
        const titleText = isGood ? "讚讚清單" : "踩雷清單";

        const items = list.length
          ? list.map(function(obj){
              const drink = obj.drink;
              const date = obj.date;
              const label = drinkLabel(drink);
              return (
                '<div class="flex justify-between gap-3 p-3 bg-[#F2F4EF] rounded-xl text-xs font-black items-start">' +
                  '<div class="flex-1 wrap-anywhere leading-snug text-slate-700">'+ escapeHtml(label) +'</div>' +
                  '<div class="opacity-40 shrink-0 pt-0.5">'+ escapeHtml(date.slice(5)) +'</div>' +
                '</div>'
              );
            }).join("")
          : '<p class="text-center text-xs text-slate-300 py-6">尚無資料</p>';

        openCenterModal({
          titleHtml:
            '<div class="flex items-center justify-center gap-2" style="color:'+titleColor+'">' +
              '<span class="inline-flex">'+ icon +'</span>' +
              '<span class="font-black">'+ titleText +'</span>' +
            '</div>',
          bodyHtml:
            '<div class="max-h-72 overflow-y-auto space-y-2 no-scrollbar">'+ items +'</div>',
          closeText: "關閉"
        });
      }

      /********************
       * Reusable centered modal
       ********************/
      function openCenterModal(opts){
        const id = "centerModal";
        const old = document.getElementById(id);
        if(old) old.remove();

        const modal = document.createElement("div");
        modal.id = id;
        modal.className = "fixed inset-0 bg-black/60 backdrop-blur-md z-[110] flex items-center justify-center p-8";
        modal.innerHTML =
          '<div class="bg-white w-full rounded-[2.5rem] p-6 shadow-2xl" style="max-width:420px;">' +
            '<div class="text-center font-black mb-4">'+ (opts.titleHtml || "") +'</div>' +
            (opts.bodyHtml || "") +
            '<button id="closeCenterModal" class="w-full mt-4 py-3 bg-[var(--main-dark)] text-white rounded-xl font-black">'+ (opts.closeText || "關閉") +'</button>' +
          '</div>';

        document.body.appendChild(modal);

        modal.addEventListener("click", function(e){
          if(e.target && e.target.id===id) closeCenterModal();
        });
        const close = document.getElementById("closeCenterModal");
        if(close) close.onclick = closeCenterModal;
      }

      function closeCenterModal(){
        const m = document.getElementById("centerModal");
        if(m) m.remove();
      }

      /********************
       * Boot
       ********************/
      // Final sanitation pass (prevents old bad data from breaking)
      (function sanitizeAll(){
        try{
          // title
          state.appTitle = safeText(state.appTitle);

          // shops
          state.shops = state.shops.map(function(x){ return safeText(x).trim(); }).filter(Boolean);
          if(!state.shops.length) state.shops = defaultShopList.slice();
          saveShops();

          // records
          const out = {};
          for(const k in (state.records||{})){
            const arr = state.records[k];
            if(!Array.isArray(arr)) continue;
            out[k] = arr.map(function(d){
              d = d || {};
              return {
                shop: safeText(d.shop),
                item: safeText(d.item),
                ice: safeText(d.ice || "去冰"),
                sugar: safeText(d.sugar || "無糖"),
                price: Number(d.price || 0) || 0,
                rating: (d.rating==="good" || d.rating==="bad") ? d.rating : null
              };
            });
          }
          state.records = out;
          saveData();
        }catch(e){
          // even sanitation shouldn't kill the app
          console.log(e);
        }
      })();

      render();

    })();
  </script>
</body>
</html>