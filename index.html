<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>è‚¥è±¬å˜‰é£²æ–™ç´€éŒ„</title>
  <style>
    :root{
      --bg:#eef2ea;
      --card:#ffffffcc;
      --ink:#5a6b43;
      --ink-2:#7a8a62;
      --muted:#94a08a;
      --line:#dfe6d7;
      --shadow: 0 10px 30px rgba(0,0,0,.06);
      --radius:22px;

      --pink:#d7a0a0;
      --pink-soft:#f2dede;

      --green:#6f8452;
      --green-soft:#e2ecd8;

      --chip:#e9efe1;
      --chip-ink:#5c6f46;

      --pill:#e6eaee;
      --danger:#c85b5b;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-rounded, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", "Heiti TC", Arial, sans-serif;
      background: var(--bg);
      color: #2b2b2b;
    }
    .wrap{
      max-width: 420px;
      margin: 0 auto;
      padding: 16px 14px 26px;
    }
    .title{
      text-align:center;
      font-weight: 800;
      letter-spacing: .06em;
      color: var(--ink);
      margin-top: 8px;
      margin-bottom: 12px;
      font-size: 20px;
    }
    .title .edit{
      display:inline-block;
      margin-left: 6px;
      opacity:.7;
      font-size: 14px;
      vertical-align: middle;
    }

    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    .stat{
      background: var(--card);
      border-radius: var(--radius);
      padding: 14px 14px 12px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .stat .cap{
      text-align:center;
      font-weight:800;
      color: var(--ink);
      font-size: 13px;
      letter-spacing:.08em;
      margin-bottom: 6px;
    }
    .stat .num{
      text-align:center;
      font-size: 18px;
      font-weight: 900;
      color: var(--ink);
    }
    .stat .num span{
      color: #2f2f2f;
      font-weight: 800;
    }
    .stat.year::before{
      content:"";
      position:absolute; left:0; top:0; width:100%; height:10px;
      background: var(--pink-soft);
    }
    .stat.year::after{
      content:"";
      position:absolute; left:0; top:0; width:100%; height:3px;
      background: var(--pink);
      opacity:.9;
    }
    .stat.month::before{
      content:"";
      position:absolute; left:0; top:0; width:100%; height:10px;
      background: var(--green-soft);
    }
    .stat.month::after{
      content:"";
      position:absolute; left:0; top:0; width:100%; height:3px;
      background: var(--green);
      opacity:.9;
    }

    .monthbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      background: var(--card);
      border-radius: 999px;
      padding: 10px 14px;
      box-shadow: var(--shadow);
      margin-bottom: 12px;
    }
    .navbtn{
      border:none;
      background:transparent;
      color: var(--ink);
      font-size: 18px;
      font-weight: 900;
      width: 38px;
      height: 34px;
      border-radius: 10px;
      cursor:pointer;
    }
    .monthbar .m{
      font-size: 20px;
      font-weight: 900;
      color: var(--ink);
      letter-spacing:.04em;
    }
    .todaybtn{
      border:none;
      background:#fff;
      color: var(--ink);
      font-weight: 900;
      padding: 8px 14px;
      border-radius: 999px;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      cursor:pointer;
    }

    .cal{
      background: rgba(255,255,255,.65);
      border-radius: 26px;
      box-shadow: var(--shadow);
      padding: 14px 10px 16px;
      border: 1px solid rgba(255,255,255,.7);
    }
    .dow{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      padding: 2px 6px 10px;
      font-weight: 900;
      letter-spacing:.2em;
      font-size: 12px;
      color: var(--ink);
      opacity:.85;
      text-align:center;
    }
    .dow div:first-child{ color:#b66b6b; }
    .grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px 6px;
      padding: 0 6px 6px;
    }
    .day{
      height: 58px;
      border-radius: 18px;
      background: rgba(255,255,255,.7);
      box-shadow: 0 10px 18px rgba(0,0,0,.04);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      position:relative;
      border: 1px solid rgba(0,0,0,.02);
    }
    .day.mute{
      opacity:.25;
      cursor:default;
    }
    .day .d{
      font-weight: 900;
      color: var(--ink);
      font-size: 16px;
      line-height: 1.1;
    }
    .day .amt{
      margin-top: 2px;
      font-size: 12px;
      font-weight: 800;
      color: #78856a;
    }
    .day.sun .d{ color:#b66b6b; }
    .day.sat .d{ color:#b66b6b; opacity:.85; }

    .day.has{
      outline: 2px solid rgba(111,132,82,.22);
      background: rgba(226,236,216,.75);
    }

    /* æˆ‘æœ€å¸¸å–ï¼šå›ºå®šè·Ÿæ—¥æ›†åŒå¯¬ */
    .favWrap{
      margin-top: 12px;
      background: rgba(255,255,255,.65);
      border-radius: 26px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.7);
      padding: 18px 12px 12px;
      position: relative;
      cursor: pointer;
      width: 100%;
    }
    .favWrap .label{
      position:absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg);
      padding: 0 10px;
      font-weight: 900;
      color: var(--ink);
      letter-spacing:.06em;
      border-radius: 999px;
    }
    .favCards{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 4px;
    }
    .favCard{
      background: rgba(255,255,255,.78);
      border-radius: 18px;
      padding: 10px 10px 9px;
      box-shadow: 0 10px 18px rgba(0,0,0,.04);
      min-height: 62px;
      border: 1px solid rgba(0,0,0,.02);
      overflow:hidden;
    }
    .favShop{
      font-weight: 900;
      color: var(--ink);
      font-size: 13px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
      text-align:center;
    }
    .favItem{
      font-weight: 800;
      color: #4c5b3a;
      font-size: 12px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      text-align:center;
      opacity:.9;
    }

    .actions{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    .act{
      background: var(--card);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 14px 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      color: var(--ink);
    }
    .act .ico{
      width: 22px; height: 22px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .act.like{ color: var(--green); }
    .act.dislike{ color: #b66b6b; }

    /* Modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.28);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px 14px;
      z-index: 50;
    }
    .overlay.show{ display:flex; }
    .modal{
      width: min(420px, 100%);
      background: #fff;
      border-radius: 28px;
      box-shadow: 0 30px 80px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modal .head{
      padding: 18px 18px 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      gap:10px;
    }
    .modal .head h3{
      margin:0;
      font-size: 20px;
      font-weight: 900;
      color: var(--ink);
      letter-spacing:.06em;
    }
    .modal .head .rightBtn{
      position:absolute;
      right: 16px;
      top: 16px;
      border:none;
      background: rgba(233,239,225,.8);
      color: var(--ink);
      font-weight: 900;
      border-radius: 999px;
      padding: 8px 12px;
      cursor:pointer;
    }
    .modal .body{
      padding: 8px 18px 16px;
    }
    .modal .foot{
      padding: 0 18px 18px;
    }
    .btn{
      width: 100%;
      border:none;
      background: var(--ink);
      color:#fff;
      font-weight: 900;
      font-size: 18px;
      padding: 14px 16px;
      border-radius: 16px;
      cursor:pointer;
      letter-spacing:.08em;
    }
    .btn.ghost{
      background: rgba(233,239,225,.85);
      color: var(--ink);
    }

    /* list row */
    .row{
      background: rgba(233,239,225,.85);
      border-radius: 14px;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .row .txt{
      min-width: 0;
      font-weight: 900;
      color: #4b5a3a;
      line-height:1.25;
      font-size: 14px;
      overflow:hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .row .pill{
      flex: 0 0 auto;
      background: var(--pill);
      color: #6e7a86;
      font-weight: 900;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 13px;
      border: 1px solid rgba(0,0,0,.04);
    }

    /* chips */
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      justify-content:center; /* ç½®ä¸­ */
      margin-top: 8px;
    }
    .chip{
      background: var(--chip);
      color: var(--chip-ink);
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 900;
      cursor:pointer;
      position:relative;
      user-select:none;
      border: 1px solid rgba(0,0,0,.03);
    }
    .chip .x{
      display:none;
      position:absolute;
      right: -6px;
      top: -6px;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: rgba(255,255,255,.9);
      border: 1px solid rgba(0,0,0,.08);
      color: var(--danger);
      font-weight: 900;
      align-items:center;
      justify-content:center;
      font-size: 14px;
    }
    .manageOn .chip .x{ display:flex; }

    .addArea{
      margin-top: 14px;
    }
    .addBtn{
      width: 100%;
      border: 2px solid rgba(111,132,82,.35);
      background: rgba(255,255,255,.75);
      color: var(--ink);
      font-weight: 900;
      padding: 14px 14px;
      border-radius: 14px;
      cursor:pointer;
      font-size: 16px;
    }

    /* custom small modal inside overlay */
    .mini{
      width: min(420px, 100%);
      background: #fff;
      border-radius: 22px;
      box-shadow: 0 30px 80px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .mini .body{ padding: 16px 18px; }
    .mini .labelTxt{
      font-weight: 900;
      color: var(--ink);
      margin-bottom: 10px;
      letter-spacing:.06em;
    }
    .mini input{
      width: 100%;
      font-size: 16px;
      padding: 12px 12px;
      border-radius: 12px;
      border: 2px solid rgba(111,132,82,.25);
      outline: none;
    }
    .mini .foot{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      padding: 0 18px 18px;
    }

    /* Error overlay (é˜²ç™½ç•«é¢) */
    #fatal{
      display:none;
      position:fixed; inset:0;
      background:#f5f6f2;
      z-index: 999;
      padding: 20px;
      overflow:auto;
    }
    #fatal h2{ margin: 6px 0 12px; color:#8a2a2a; }
    #fatal pre{
      background:#fff;
      border:1px solid #eee;
      padding: 12px;
      border-radius: 12px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* icons */
    .svgStroke{
      stroke: currentColor;
      fill: none;
      stroke-width: 2.2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    .icoBox{
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 2px solid rgba(111,132,82,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--ink);
      flex: 0 0 auto;
    }
    .cupImg{
      width: 18px; height: 18px;
      object-fit: contain;
      display:block;
    }
  </style>
</head>

<body>
  <div id="fatal">
    <h2>JS Errorï¼ˆä½†æˆ‘ä¸è®“ä½ ç™½ç•«é¢ï¼‰</h2>
    <p style="color:#666;font-weight:800">æŠŠä¸‹é¢è¨Šæ¯æˆªåœ–çµ¦æˆ‘ï¼Œæˆ‘å¯ä»¥ç¹¼çºŒç²¾æº–ä¿®ï¼š</p>
    <pre id="fatalMsg"></pre>
  </div>

  <div class="wrap" id="app" style="display:none">
    <div class="title">â€” è‚¥è±¬å˜‰çš„èª•ç”Ÿ <span class="edit">âœ</span></div>

    <div class="stats">
      <div class="stat year">
        <div class="cap">å¹´åº¦ç´¯è¨ˆ</div>
        <div class="num"><span id="yCups">0</span> æ¯ã€€$<span id="yMoney">0</span></div>
      </div>
      <div class="stat month">
        <div class="cap">æœ¬æœˆçµ±è¨ˆ</div>
        <div class="num"><span id="mCups">0</span> æ¯ã€€$<span id="mMoney">0</span></div>
      </div>
    </div>

    <div class="monthbar">
      <button class="navbtn" id="prevBtn">â€¹</button>
      <div class="m" id="monthTitle">2026.01</div>
      <button class="navbtn" id="nextBtn">â€º</button>
      <button class="todaybtn" id="todayBtn">ä»Šå¤©</button>
    </div>

    <div class="cal">
      <div class="dow">
        <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
      </div>
      <div class="grid" id="grid"></div>
    </div>

    <!-- æˆ‘æœ€å¸¸å– -->
    <div class="favWrap" id="favWrap" title="é»æˆ‘çœ‹æœ€å¸¸å–æ’å">
      <div class="label">æˆ‘æœ€å¸¸å–</div>
      <div class="favCards" id="favCards"></div>
    </div>

    <div class="actions">
      <div class="act like" id="likeBtn">
        <span class="ico" id="likeIco"></span>
        è®šè®š (<span id="likeCount">0</span>)
      </div>
      <div class="act dislike" id="dislikeBtn">
        <span class="ico" id="dislikeIco"></span>
        è¸©é›· (<span id="dislikeCount">0</span>)
      </div>
    </div>
  </div>

  <!-- åº—å®¶é¸æ“‡ -->
  <div class="overlay" id="shopOverlay" aria-hidden="true">
    <div class="modal">
      <div class="head">
        <h3>é¸æ“‡åº—å®¶</h3>
        <button class="rightBtn" id="manageShopBtn">ç®¡ç†</button>
      </div>
      <div class="body" id="shopBody">
        <div class="chips" id="shopChips"></div>
        <div class="addArea">
          <button class="addBtn" id="addShopBtn">ï¼‹ æ–°å¢åº—å®¶</button>
        </div>
      </div>
      <div class="foot">
        <button class="btn" id="closeShopBtn">é—œé–‰</button>
      </div>
    </div>
  </div>

  <!-- æ–°å¢åº—å®¶ï¼ˆè‡ªå®¶é¢¨æ ¼ï¼Œä¸ç”¨ promptï¼‰ -->
  <div class="overlay" id="addShopOverlay" aria-hidden="true">
    <div class="mini">
      <div class="body">
        <div class="labelTxt">æ–°å¢åº—å®¶åç¨±ï¼š</div>
        <input id="newShopInput" placeholder="ä¾‹å¦‚ï¼šæ¸…å¿ƒã€å†ç¡5åˆ†é˜â€¦" maxlength="20" />
      </div>
      <div class="foot">
        <button class="btn ghost" id="newShopCancel">å–æ¶ˆ</button>
        <button class="btn" id="newShopOk">æ–°å¢</button>
      </div>
    </div>
  </div>

  <!-- æœ€å¸¸å–æ’å -->
  <div class="overlay" id="rankOverlay" aria-hidden="true">
    <div class="modal">
      <div class="head">
        <div class="icoBox" id="rankIco"></div>
        <h3>æœ€å¸¸å–æ’å</h3>
      </div>
      <div class="body" id="rankBody"></div>
      <div class="foot">
        <button class="btn" id="closeRankBtn">é—œé–‰</button>
      </div>
    </div>
  </div>

  <!-- è®šè®šæ¸…å–® -->
  <div class="overlay" id="likeOverlay" aria-hidden="true">
    <div class="modal">
      <div class="head">
        <div class="icoBox" id="likeHeadIco"></div>
        <h3>è®šè®šæ¸…å–®</h3>
      </div>
      <div class="body" id="likeBody"></div>
      <div class="foot">
        <button class="btn" id="closeLikeBtn">é—œé–‰</button>
      </div>
    </div>
  </div>

  <!-- è¸©é›·æ¸…å–® -->
  <div class="overlay" id="dislikeOverlay" aria-hidden="true">
    <div class="modal">
      <div class="head">
        <div class="icoBox" id="dislikeHeadIco"></div>
        <h3>è¸©é›·ç´€éŒ„</h3>
      </div>
      <div class="body" id="dislikeBody"></div>
      <div class="foot">
        <button class="btn" id="closeDislikeBtn">é—œé–‰</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const LS_KEY = "drinklog_v3_data";
  const LS_SHOPS = "drinklog_v3_shops";

  const DEFAULT_SHOPS = ["äº”ååµ","å¯ä¸å¯","éº»å¤","å¾—æ­£","äº”æ¡è™Ÿ","é¶´èŒ¶æ¨“","è¿·å®¢å¤","å¤§è‹‘å­"];

  const state = {
    viewY: null,
    viewM: null, // 0-11
    records: [],
    shops: [],
    manageShop: false
  };

  // ---------- helpers ----------
  const pad2 = n => String(n).padStart(2,"0");
  const ymKey = (y,m) => `${y}-${pad2(m+1)}`;
  const today = () => {
    const d=new Date();
    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
  };
  const dateKey = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

  function safeLoad(){
    // records
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(raw){
        const parsed = JSON.parse(raw);
        if(Array.isArray(parsed)) state.records = parsed;
      }
    }catch(e){
      // å£æ‰å°±é‡å»ºï¼Œé¿å…ç™½ç•«é¢
      state.records = [];
      localStorage.removeItem(LS_KEY);
    }

    // shops
    try{
      const rawS = localStorage.getItem(LS_SHOPS);
      if(rawS){
        const parsedS = JSON.parse(rawS);
        if(Array.isArray(parsedS)) state.shops = parsedS;
      }
    }catch(e){
      state.shops = [...DEFAULT_SHOPS];
      localStorage.removeItem(LS_SHOPS);
    }

    if(!state.shops || !state.shops.length){
      state.shops = [...DEFAULT_SHOPS];
    }
    // å»é‡ + æ¸…ç†ç©ºç™½
    state.shops = Array.from(new Set(state.shops.map(s => String(s||"").trim()).filter(Boolean)));
    saveShops();
  }

  function save(){
    try{
      localStorage.setItem(LS_KEY, JSON.stringify(state.records));
    }catch(e){
      // localStorage æ»¿çš„æ©Ÿç‡å¾ˆä½ï¼Œä½†å°±ç®—æ»¿ä¹Ÿä¸è¦ç™½
      console.warn("save failed", e);
    }
  }
  function saveShops(){
    try{
      localStorage.setItem(LS_SHOPS, JSON.stringify(state.shops));
    }catch(e){
      console.warn("save shops failed", e);
    }
  }

  function sumBy(filterFn){
    let cups=0, money=0;
    for(const r of state.records){
      if(filterFn(r)){
        cups += 1;
        money += Number(r.price||0);
      }
    }
    return {cups, money};
  }

  function getDayTotal(y,m,day){
    const k = `${y}-${pad2(m+1)}-${pad2(day)}`;
    let money = 0;
    for(const r of state.records){
      if(r.date === k) money += Number(r.price||0);
    }
    return money;
  }

  // æœ€å¸¸å–ï¼šä»¥ã€Œåº—å®¶+å“é …+ç”œåº¦+å†°é‡ã€ç‚º key
  function favAgg(){
    const map = new Map();
    for(const r of state.records){
      const shop = (r.shop||"").trim();
      const item = (r.item||"").trim();
      const sugar = (r.sugar||"").trim();
      const ice = (r.ice||"").trim();
      if(!shop || !item) continue;
      const key = `${shop}__${item}__${sugar}__${ice}`;
      map.set(key, (map.get(key)||0)+1);
    }
    const arr = Array.from(map.entries()).map(([key,count]) => {
      const [shop,item,sugar,ice] = key.split("__");
      return {shop,item,sugar,ice,count, key};
    });
    arr.sort((a,b)=> b.count - a.count);
    return arr;
  }

  // ---------- icons (ç©ºå¿ƒé¢¨æ ¼) ----------
  function svgSignal(){
    return `
      <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
        <path class="svgStroke" d="M4 20v-4"></path>
        <path class="svgStroke" d="M9 20v-7"></path>
        <path class="svgStroke" d="M14 20v-10"></path>
        <path class="svgStroke" d="M19 20v-14"></path>
      </svg>
    `;
  }
  function svgThumbUp(){
    return `
      <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
        <path class="svgStroke" d="M7 11v10"></path>
        <path class="svgStroke" d="M7 11h9l1 2v8l-1 1H9a2 2 0 0 1-2-2v-9z"></path>
        <path class="svgStroke" d="M7 11l4-7h2v6"></path>
      </svg>
    `;
  }
  function svgThumbDown(){
    return `
      <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
        <path class="svgStroke" d="M17 13V3"></path>
        <path class="svgStroke" d="M17 13H8l-1-2V3l1-1h7a2 2 0 0 1 2 2v9z"></path>
        <path class="svgStroke" d="M17 13l-4 7h-2v-6"></path>
      </svg>
    `;
  }
  function svgCupFallback(){
    return `
      <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
        <path class="svgStroke" d="M7 7h10l-1 13H8L7 7z"></path>
        <path class="svgStroke" d="M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
      </svg>
    `;
  }

  // ---------- UI ----------
  const $ = (sel) => document.querySelector(sel);

  function renderHeader(){
    $("#monthTitle").textContent = `${state.viewY}.${pad2(state.viewM+1)}`;

    const year = state.viewY;
    const month = state.viewM;

    const ySum = sumBy(r => (r.date||"").startsWith(`${year}-`));
    const mSum = sumBy(r => (r.date||"").startsWith(`${year}-${pad2(month+1)}-`));

    $("#yCups").textContent = ySum.cups;
    $("#yMoney").textContent = ySum.money;
    $("#mCups").textContent = mSum.cups;
    $("#mMoney").textContent = mSum.money;
  }

  function renderCalendar(){
    const y = state.viewY, m = state.viewM;
    const first = new Date(y,m,1);
    const startDow = first.getDay(); // 0 sun
    const daysInMonth = new Date(y, m+1, 0).getDate();

    const grid = $("#grid");
    grid.innerHTML = "";

    // 42 cells
    const totalCells = 42;
    let dayNum = 1 - startDow;

    for(let i=0;i<totalCells;i++, dayNum++){
      const cellDate = new Date(y, m, dayNum);
      const inMonth = cellDate.getMonth() === m;
      const d = cellDate.getDate();
      const dow = cellDate.getDay();

      const div = document.createElement("div");
      div.className = "day" + (inMonth ? "" : " mute") + (dow===0 ? " sun" : "") + (dow===6 ? " sat" : "");

      if(inMonth){
        const total = getDayTotal(y,m,d);
        if(total>0) div.classList.add("has");

        div.innerHTML = `
          <div class="d">${d}</div>
          <div class="amt">${total>0 ? "$"+total : ""}</div>
        `;

        div.addEventListener("click", ()=> openDayEditor(cellDate));
      }else{
        div.innerHTML = `<div class="d">${d}</div><div class="amt"></div>`;
      }

      grid.appendChild(div);
    }
  }

  // æˆ‘æœ€å¸¸å–ï¼šä¸»ç•«é¢åªé¡¯ç¤ºå‰ä¸‰ï¼ˆåº—å®¶+å“é …ï¼‰
  function renderFavCards(){
    const fav = favAgg().slice(0,3);
    const box = $("#favCards");
    box.innerHTML = "";

    // è£œæ»¿ä¸‰æ ¼ï¼ˆä¿æŒç‰ˆé¢ï¼‰
    for(let i=0;i<3;i++){
      const c = document.createElement("div");
      c.className = "favCard";
      if(fav[i]){
        c.innerHTML = `
          <div class="favShop">${escapeHtml(fav[i].shop)}</div>
          <div class="favItem">${escapeHtml(fav[i].item)}</div>
        `;
      }else{
        c.innerHTML = `
          <div class="favShop" style="opacity:.35">â€”</div>
          <div class="favItem" style="opacity:.25">å°šç„¡</div>
        `;
      }
      box.appendChild(c);
    }
  }

  function renderLikeDislikeCounts(){
    const likes = state.records.filter(r=>r.like===true).length;
    const dislikes = state.records.filter(r=>r.dislike===true).length;
    $("#likeCount").textContent = likes;
    $("#dislikeCount").textContent = dislikes;
  }

  // ---------- Modals ----------
  function showOverlay(id){
    const el = $(id);
    el.classList.add("show");
    el.setAttribute("aria-hidden","false");
  }
  function hideOverlay(id){
    const el = $(id);
    el.classList.remove("show");
    el.setAttribute("aria-hidden","true");
  }

  // Day editorï¼šç‚ºäº†ä¸æŠŠä½ éœ€æ±‚è¶Šåšè¶Šå¤§ï¼Œé€™è£¡å…ˆç”¨æœ€å®‰å…¨çš„ã€Œç°¡åŒ–è¼¸å…¥ã€
  // ï¼ˆä½ ç›®å‰é‡é»åœ¨ç‰ˆé¢/ç™½ç•«é¢/åº—å®¶ç®¡ç†/æœ€å¸¸å–æ’åï¼‰
  function openDayEditor(d){
    // å…ˆåªåšï¼šé¸åº—å®¶ï¼ˆåŒé¢¨æ ¼ modalï¼‰ï¼Œå…¶é¤˜ä½ ä¹‹å¾Œè¦å†æ“´
    // é€™è£¡ç¤ºç¯„ï¼šé»æŸæ—¥ â†’ å…ˆé–‹é¸åº—å®¶ â†’ ç›´æ¥åŠ ä¸€ç­†ï¼ˆå“é …/ç”œåº¦/å†°é‡ç”¨é è¨­å€¼ï¼Œé¿å…ä½ åˆè¢« prompt æé¢¨æ ¼ä¸ä¸€ï¼‰
    state._pendingDate = dateKey(d);
    renderShopChips();
    showOverlay("#shopOverlay");
  }

  function renderShopChips(){
    const wrap = $("#shopChips");
    wrap.innerHTML = "";
    const body = $("#shopBody");
    body.classList.toggle("manageOn", state.manageShop);

    state.shops.forEach((name, idx) => {
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.textContent = name;

      const x = document.createElement("div");
      x.className = "x";
      x.textContent = "Ã—";

      x.addEventListener("click", (ev) => {
        ev.stopPropagation();
        // åˆªé™¤åº—å®¶ï¼ˆé è¨­ä¹Ÿèƒ½åˆªï¼‰
        state.shops.splice(idx,1);
        saveShops();
        renderShopChips();
      });

      chip.appendChild(x);

      chip.addEventListener("click", () => {
        if(state.manageShop) return;

        // æ–°å¢ä¸€ç­†æœ€å°è¨˜éŒ„ï¼šä½ ä¹‹å¾Œè¦å®Œæ•´è¡¨å–®å†åŠ 
        const rec = {
          date: state._pendingDate,
          shop: name,
          item: "ï¼ˆæœªå¡«å“é …ï¼‰",
          sugar: "ç„¡ç³–",
          ice: "å»å†°",
          price: 0,
          like: false,
          dislike: false
        };
        state.records.push(rec);
        save();
        hideOverlay("#shopOverlay");
        state._pendingDate = null;
        refreshAll();
      });

      wrap.appendChild(chip);
    });
  }

  function openAddShop(){
    $("#newShopInput").value = "";
    showOverlay("#addShopOverlay");
    setTimeout(()=> $("#newShopInput").focus(), 50);
  }

  function addShopConfirm(){
    const v = ($("#newShopInput").value || "").trim();
    if(!v) return;
    if(!state.shops.includes(v)){
      state.shops.push(v);
      saveShops();
    }
    hideOverlay("#addShopOverlay");
    renderShopChips();
  }

  function openRank(){
    const list = favAgg(); // å…¨éƒ¨æ’åº
    const body = $("#rankBody");
    body.innerHTML = "";

    if(list.length===0){
      body.innerHTML = `<div style="text-align:center;color:#9aa58f;font-weight:900;padding:18px 0;">å°šç„¡è³‡æ–™</div>`;
    }else{
      list.slice(0, 20).forEach(row => {
        const el = document.createElement("div");
        el.className = "row";
        const title = `${row.shop}-${row.item}ï¼ˆ${row.sugar}/${row.ice}ï¼‰`;
        el.innerHTML = `
          <div class="txt" title="${escapeAttr(title)}">${escapeHtml(title)}</div>
          <div class="pill">${row.count}æ¬¡</div>
        `;
        body.appendChild(el);
      });
    }

    showOverlay("#rankOverlay");
  }

  function openLikeList(){
    const body = $("#likeBody");
    body.innerHTML = "";
    const list = state.records.filter(r=>r.like===true);
    if(list.length===0){
      body.innerHTML = `<div style="text-align:center;color:#9aa58f;font-weight:900;padding:18px 0;">å°šç„¡è³‡æ–™</div>`;
    }else{
      list.slice().reverse().forEach(r=>{
        const title = `${r.shop||""}-${r.item||""}ï¼ˆ${r.sugar||""}/${r.ice||""}ï¼‰`;
        const el = document.createElement("div");
        el.className = "row";
        el.innerHTML = `<div class="txt" title="${escapeAttr(title)}">${escapeHtml(title)}</div><div class="pill">${(r.date||"").slice(5)}</div>`;
        body.appendChild(el);
      });
    }
    showOverlay("#likeOverlay");
  }

  function openDislikeList(){
    const body = $("#dislikeBody");
    body.innerHTML = "";
    const list = state.records.filter(r=>r.dislike===true);
    if(list.length===0){
      body.innerHTML = `<div style="text-align:center;color:#9aa58f;font-weight:900;padding:18px 0;">å°šç„¡è³‡æ–™</div>`;
    }else{
      list.slice().reverse().forEach(r=>{
        const title = `${r.shop||""}-${r.item||""}ï¼ˆ${r.sugar||""}/${r.ice||""}ï¼‰`;
        const el = document.createElement("div");
        el.className = "row";
        el.innerHTML = `<div class="txt" title="${escapeAttr(title)}">${escapeHtml(title)}</div><div class="pill">${(r.date||"").slice(5)}</div>`;
        body.appendChild(el);
      });
    }
    showOverlay("#dislikeOverlay");
  }

  // ---------- escaping ----------
  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }
  function escapeAttr(s){
    return escapeHtml(s).replaceAll("\n"," ");
  }

  // ---------- refresh ----------
  function refreshAll(){
    renderHeader();
    renderCalendar();
    renderFavCards();
    renderLikeDislikeCounts();
  }

  // ---------- init ----------
  function init(){
    safeLoad();

    const t = today();
    state.viewY = t.getFullYear();
    state.viewM = t.getMonth();

    // icons
    $("#rankIco").innerHTML = svgSignal();
    $("#likeIco").innerHTML = svgThumbUp();
    $("#dislikeIco").innerHTML = svgThumbDown();
    $("#likeHeadIco").innerHTML = svgThumbUp();
    $("#dislikeHeadIco").innerHTML = svgThumbDown();

    // ä½ æåˆ°ã€Œç©ºå¿ƒé£²æ–™æ¯ icon ä¸è¦‹ã€ï¼šé€™è£¡åšä¸€å€‹å¯ç”¨çš„ï¼ˆæœ‰ png å°±ç”¨ pngï¼Œæ²’æœ‰å°± fallback SVGï¼‰
    // ä½†ä½ ç›®å‰ã€Œæœ€å¸¸å–ã€æ”¹æˆæ–‡å­—äº†ï¼Œæ‰€ä»¥æ¯å­ icon åªæ”¾åœ¨ã€Œæœ€å¸¸å–æ’åã€æ¨™é¡Œå·¦é‚Šçš„åœ“æ¡†å…§å·²æ˜¯ğŸ“¶
    // å¦‚æœä½ ä¹‹å¾Œé‚„æƒ³åœ¨åˆ¥è™•æ”¾æ¯å­ iconï¼Œå†å«æˆ‘ï¼Œæˆ‘å¹«ä½ å¡ã€‚
    // ï¼ˆå…ˆæŠŠ png å¯ç”¨æ€§æª¢æŸ¥ç•™è‘—ï¼‰
    const img = new Image();
    img.src = "cup.png";
    img.onload = () => {/* ok */};
    img.onerror = () => {/* æ²’æª”ä¹Ÿä¸å½±éŸ¿ */};

    // buttons
    $("#prevBtn").addEventListener("click", ()=>{
      state.viewM -= 1;
      if(state.viewM < 0){ state.viewM = 11; state.viewY -= 1; }
      refreshAll();
    });
    $("#nextBtn").addEventListener("click", ()=>{
      state.viewM += 1;
      if(state.viewM > 11){ state.viewM = 0; state.viewY += 1; }
      refreshAll();
    });
    $("#todayBtn").addEventListener("click", ()=>{
      const t = today();
      state.viewY = t.getFullYear();
      state.viewM = t.getMonth();
      refreshAll();
    });

    // æˆ‘æœ€å¸¸å–ï¼šé»æ•´å€‹æ¡† â†’ æ’åæ¸…å–®
    $("#favWrap").addEventListener("click", openRank);

    // like/dislike lists
    $("#likeBtn").addEventListener("click", openLikeList);
    $("#dislikeBtn").addEventListener("click", openDislikeList);

    // shop modal
    $("#closeShopBtn").addEventListener("click", ()=> hideOverlay("#shopOverlay"));
    $("#addShopBtn").addEventListener("click", openAddShop);
    $("#manageShopBtn").addEventListener("click", ()=>{
      state.manageShop = !state.manageShop;
      $("#manageShopBtn").textContent = state.manageShop ? "å®Œæˆ" : "ç®¡ç†";
      renderShopChips();
    });

    // add shop modal
    $("#newShopCancel").addEventListener("click", ()=> hideOverlay("#addShopOverlay"));
    $("#newShopOk").addEventListener("click", addShopConfirm);
    $("#addShopOverlay").addEventListener("click", (e)=>{
      if(e.target.id === "addShopOverlay") hideOverlay("#addShopOverlay");
    });

    // rank modal
    $("#closeRankBtn").addEventListener("click", ()=> hideOverlay("#rankOverlay"));

    // like/dislike modals close
    $("#closeLikeBtn").addEventListener("click", ()=> hideOverlay("#likeOverlay"));
    $("#closeDislikeBtn").addEventListener("click", ()=> hideOverlay("#dislikeOverlay"));

    // click outside modal to close (optional)
    ["shopOverlay","rankOverlay","likeOverlay","dislikeOverlay"].forEach(id=>{
      const el = document.getElementById(id);
      el.addEventListener("click", (e)=>{
        if(e.target.id === id) hideOverlay("#"+id);
      });
    });

    // show app
    $("#app").style.display = "";
    refreshAll();
  }

  try{
    init();
  }catch(err){
    console.error(err);
    $("#fatal").style.display = "block";
    $("#fatalMsg").textContent = String(err && err.stack ? err.stack : err);
  }
})();
</script>
</body>
</html>