<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>é£²æ–™ç´€éŒ„</title>

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="é£²æ–™ç´€éŒ„" />

  <!-- iOS ä¸»ç•«é¢ iconï¼ˆåƒä½ ç¾åœ¨çš„ .PNG + å…¼å®¹å°å¯«ï¼‰ -->
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.PNG">
  <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
  <link rel="icon" type="image/png" href="./apple-touch-icon.PNG">
  <link rel="icon" type="image/png" href="./apple-touch-icon.png">

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');

    :root{
      --main:#8A9A5B;
      --main-dark:#556B2F;
      --bg:#F2F4EF;
      --weekend:#C08282;
      --today-border:#CFE0B8;

      /* âœ… å›ºå®šæ—¥æ›†ï¼šæ°¸é  6 é€±ï¼Œé¿å…æœˆä»½è·³å‹• */
      --cal-gap: 10px;
      --cal-pad-x: 16px;
      --cal-pad-top: 12px;
      --cal-pad-bot: 14px;
      --cell-h: 46px;  /* iPhone ä¸Šçœ‹èµ·ä¾†æ¥è¿‘ä½ åœ–çš„å¤§å° */
      --cell-r: 18px;
    }

    html, body { height:100%; background:var(--bg); }
    body{
      font-family:'Noto Sans TC', system-ui, -apple-system, "PingFang TC", "Heiti TC", sans-serif;
      -webkit-tap-highlight-color: transparent;
      background: var(--bg);
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      overscroll-behavior-y: none;
    }
    input, button{ font-size:16px; }
    .no-scrollbar::-webkit-scrollbar{ display:none; }

    /* è®“ä¸»ç•«é¢ä¸€å±ï¼ˆä¸äº‚æ»¾ï¼‰ */
    #app{ height:100svh; }

    /* âœ… æ˜ŸæœŸåˆ— & æ—¥æ›†æ ¼ï¼šå…±ç”¨åŒä¸€å¥— gridï¼Œè§£å°é½Šå•é¡Œ */
    .cal-grid{
      display:grid;
      grid-template-columns:repeat(7, minmax(0,1fr));
      gap: var(--cal-gap);
      padding: var(--cal-pad-top) var(--cal-pad-x) var(--cal-pad-bot);
    }
    .dow-grid{
      padding-bottom: 6px; /* è®“æ˜ŸæœŸåˆ—è·Ÿç¬¬ä¸€æ’æ ¼å­èˆ’æœä¸€é» */
    }

    .day-cell{
      height: var(--cell-h);
      border-radius: var(--cell-r);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
    }
    .today-ring{
      outline: 2px solid var(--today-border);
      outline-offset: -2px;
    }

    .modal-sheet{
      max-height: 85svh;
      overflow-y:auto;
      -webkit-overflow-scrolling: touch;
    }

    /* Debug overlay */
    #fatal{
      display:none; position:fixed; inset:0; background:#fff; padding:16px;
      z-index:9999; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
    }
    #fatal pre{ white-space:pre-wrap; font-size:12px; line-height:1.4; }
  </style>
</head>

<body>
  <div id="fatal">
    <h2 style="font-size:16px; font-weight:700; margin-bottom:8px;">é é¢çˆ†äº†ï¼ˆJS Errorï¼‰</h2>
    <pre id="fatalMsg"></pre>
  </div>

  <div id="app" class="max-w-md mx-auto px-4 flex flex-col overflow-hidden"></div>

  <script>
    // ====== ç™½ç•«é¢è‡ªæ•‘ï¼šæŠŠéŒ¯èª¤åå‡ºä¾† ======
    window.addEventListener("error", (e) => {
      const box = document.getElementById("fatal");
      const msg = document.getElementById("fatalMsg");
      if (box && msg) {
        box.style.display = "block";
        msg.textContent = `Error: ${e.message}\nFile: ${e.filename}\nLine: ${e.lineno}:${e.colno}`;
      }
    });
    window.addEventListener("unhandledrejection", (e) => {
      const box = document.getElementById("fatal");
      const msg = document.getElementById("fatalMsg");
      if (box && msg) {
        box.style.display = "block";
        msg.textContent = `Promise Rejection: ${String(e.reason)}`;
      }
    });

    /********************
     * Storage Keys
     ********************/
    const KEY_TITLE = "fpj_app_title";
    const KEY_DATA  = "fpj_offline_data_v3";
    const KEY_SHOPS = "fpj_shop_list_v1";

    /********************
     * Options
     ********************/
    const iceOptions   = ["æ­£å¸¸","å°‘å†°","å¾®å†°","å»å†°","å¸¸æº«","æº«","ç†±","å›ºå®š"];
    const sugarOptions = ["å…¨ç³–","å°‘ç³–","åŠç³–","å¾®ç³–","ä¸€åˆ†","0.5åˆ†","ç„¡ç³–","å›ºå®š"];

    const defaultShops = ["äº”ååµ","å¯ä¸å¯","éº»å¤","å¾—æ­£","äº”æ¡è™Ÿ","é¶´èŒ¶æ¨“","è¿·å®¢å¤","å¤§è‹‘å­"];

    /********************
     * State
     ********************/
    const today = new Date();
    let state = {
      currentDate: new Date(today.getFullYear(), today.getMonth(), 1),
      selectedDate: null,
      appTitle: localStorage.getItem(KEY_TITLE) || "ä¸€éš»è‚¥è±¬å˜‰çš„èª•ç”Ÿ",
      isEditingTitle: false,
      records: safeParse(localStorage.getItem(KEY_DATA)) || {},
      shops: loadShops(),
      shopPicker: { open:false, targetIdx:null, manage:false },
    };

    function safeParse(s){ try{ return JSON.parse(s); }catch(e){ return null; } }
    function saveData(){ localStorage.setItem(KEY_DATA, JSON.stringify(state.records)); }
    function saveTitle(t){ state.appTitle = t; localStorage.setItem(KEY_TITLE, t); }

    function loadShops(){
      const saved = safeParse(localStorage.getItem(KEY_SHOPS));
      if(Array.isArray(saved) && saved.length) return uniqueList(saved);
      return [...defaultShops];
    }
    function saveShops(){ localStorage.setItem(KEY_SHOPS, JSON.stringify(uniqueList(state.shops))); }
    function uniqueList(arr){
      const seen = new Set(); const out = [];
      for(const x of arr){
        const v = String(x||"").trim();
        if(!v) continue;
        if(seen.has(v)) continue;
        seen.add(v); out.push(v);
      }
      return out;
    }

    function formatDateKey(d){
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }
    function parseKeyDate(key){
      const [y,m,d] = String(key).split("-").map(n=>Number(n));
      if(!y || !m || !d) return null;
      return new Date(y, m-1, d);
    }
    function sameDay(a,b){
      return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
    }
    function ensureDayArray(dateKey){
      if(!state.records[dateKey]) state.records[dateKey] = [];
      return state.records[dateKey];
    }
    function defaultDrink(){
      return { shop:"", item:"", ice:"å»å†°", sugar:"ç„¡ç³–", price:0, rating:null };
    }

    // iOS ç©©å®šç‰ˆ escapeï¼ˆä¸ä½¿ç”¨ replaceAllï¼‰
    function escapeHtml(s){
      return String(s||"")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    /********************
     * Icons (outline)
     ********************/
    function thumbIcon(color){
      return `
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3z"/>
          <path d="M7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/>
        </svg>
      `;
    }
    function thumbDownIcon(color){
      return `
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3z"/>
          <path d="M17 2h3a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2h-3"/>
        </svg>
      `;
    }

    /********************
     * Stats
     * - TOPï¼šä»¥ã€Œåº—å®¶-å“é …ã€æ¬¡æ•¸æ’åº
     * - æˆ‘æœ€å¸¸å–ï¼šé¡¯ç¤ºã€Œåº—å®¶-å“é …ï¼ˆç”œåº¦/å†°é‡ï¼‰ã€ä¸¦æŒ‘è©² combo ä¸­æœ€å¤šæ¬¡çš„ç”œå†°çµ„åˆ
     ********************/
    function calculateStats(){
      const y = state.currentDate.getFullYear();
      const m = state.currentDate.getMonth();

      let yTotal=0, yCount=0, mTotal=0, mCount=0;

      const comboFreq = {};          // shop-item -> count
      const comboVariantFreq = {};   // shop-item -> { "ç„¡ç³–/å»å†°": count, ... }

      const goodList = [];
      const badList  = [];

      for(const key of Object.keys(state.records)){
        const dt = parseKeyDate(key);
        if(!dt) continue;

        const isYear  = dt.getFullYear() === y;
        const isMonth = isYear && dt.getMonth() === m;

        for(const drink of (state.records[key]||[])){
          const price = Number(drink.price || 0);
          if(isYear){ yTotal += price; yCount++; }
          if(isMonth){ mTotal += price; mCount++; }

          const shop = (drink.shop||"").trim();
          const item = (drink.item||"").trim();
          if(shop && item){
            const combo = `${shop}-${item}`;
            comboFreq[combo] = (comboFreq[combo]||0) + 1;

            const variant = `${drink.sugar||"ç„¡ç³–"}/${drink.ice||"å»å†°"}`;
            if(!comboVariantFreq[combo]) comboVariantFreq[combo] = {};
            comboVariantFreq[combo][variant] = (comboVariantFreq[combo][variant]||0) + 1;
          }

          if(drink.rating === "good") goodList.push({drink, date:key});
          if(drink.rating === "bad")  badList.push({drink, date:key});
        }
      }

      const topCombos = Object.entries(comboFreq)
        .sort((a,b)=>b[1]-a[1])
        .slice(0,3)
        .map(([combo,count])=>{
          const variants = comboVariantFreq[combo] || {};
          let bestVariant = "ç„¡ç³–/å»å†°";
          let bestC = -1;
          for(const [v,c] of Object.entries(variants)){
            if(c > bestC){
              bestC = c;
              bestVariant = v;
            }
          }
          return { combo, count, bestVariant };
        });

      return { yTotal, yCount, mTotal, mCount, topCombos, goodList, badList };
    }

    /********************
     * Render
     ********************/
    function render(){
      const app = document.getElementById("app");
      const stats = calculateStats();

      const year = state.currentDate.getFullYear();
      const month = state.currentDate.getMonth();
      const daysInMonth = new Date(year, month+1, 0).getDate();
      const firstDay = new Date(year, month, 1).getDay();

      // Title
      let titleHtml = "";
      if(state.isEditingTitle){
        titleHtml = `
          <input id="titleInput" type="text"
            class="text-xl font-black text-[var(--main)] text-center bg-white rounded-full px-4 py-2 border-2 border-[var(--main)] w-full max-w-[280px] outline-none"
            value="${escapeHtml(state.appTitle)}" />
        `;
      }else{
        titleHtml = `
          <div id="titleDisplay" class="flex items-center gap-2 cursor-pointer active:opacity-60 select-none">
            <h1 class="text-xl font-black tracking-widest text-[var(--main)]">${escapeHtml(state.appTitle)}</h1>
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--main)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-50">
              <path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
            </svg>
          </div>
        `;
      }

      // âœ… æ°¸é ç•«æ»¿ 6 é€±ï¼ˆ42 æ ¼ï¼‰ï¼Œè§£ã€Œæœˆä»½è·³å‹•ã€
      const cells = [];
      for(let i=0;i<firstDay;i++) cells.push({type:"blank"});
      for(let d=1; d<=daysInMonth; d++) cells.push({type:"day", d});
      while(cells.length < 42) cells.push({type:"blank"});

      let calendarCells = "";
      for(const c of cells){
        if(c.type==="blank"){
          calendarCells += `<div class="day-cell opacity-0 pointer-events-none"></div>`;
          continue;
        }
        const d = c.d;
        const dateObj = new Date(year, month, d);
        const key = formatDateKey(dateObj);
        const list = state.records[key] || [];
        const count = list.length;

        const idx = (firstDay + d - 1) % 7;
        const isWeekend = (idx === 0) || (idx === 6);
        const isToday = sameDay(dateObj, today);

        let bgClass = "bg-white/40";
        if(count===1) bgClass = "bg-[#E1EAD1]";
        if(count===2) bgClass = "bg-[#FEF5D4]";
        if(count>=3) bgClass = "bg-[#FEE2E2]";

        const daySum = count>0 ? list.reduce((s,i)=>s+Number(i.price||0),0) : 0;

        calendarCells += `
          <button data-day="${d}" class="day-cell ${bgClass} ${isToday ? "today-ring" : ""} w-full border border-white/60 shadow-sm active:scale-95 transition-transform relative">
            <span class="text-[12px] font-black" style="color:${isWeekend ? 'var(--weekend)' : 'var(--main-dark)'}">${d}</span>
            ${count>0 ? `<span class="text-[9px] font-bold text-slate-400 leading-none mt-0.5">$${daySum}</span>` : ``}
          </button>
        `;
      }

      const goodCount = stats.goodList.length;
      const badCount  = stats.badList.length;

      // TOP cards (3)
      const topCards = stats.topCombos.length
        ? stats.topCombos.map(({combo})=>{
            const [shop, ...rest] = combo.split("-");
            const item = rest.join("-"); // é˜²æ­¢å“é …è‡ªå·±æœ‰ '-'
            return `
              <div class="bg-white/85 rounded-2xl border border-[#E1EAD1] px-3 py-3 text-center">
                <div class="text-[13px] font-black text-[var(--main-dark)] leading-tight">${escapeHtml(shop)}</div>
                <div class="text-[11px] font-bold text-slate-400 mt-1 leading-tight">${escapeHtml(item || "")}</div>
              </div>
            `;
          }).join("")
        : `<div class="text-[11px] text-slate-300 italic text-center w-full py-4">å°šæœªç”¢ç”Ÿæ’å...</div>`;

      app.innerHTML = `
        <!-- Header -->
        <div class="flex justify-center items-center pt-4 pb-3 shrink- telling-0">
          ${titleHtml}
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-2 gap-3 mb-3 shrink-0">
          <div class="bg-white/80 p-3 rounded-[1.5rem] shadow-sm border border-white text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-[#CD5C5C]/20"></div>
            <p class="text-[10px] font-black text-[#CD5C5C] mb-1 tracking-widest">å¹´åº¦ç´¯è¨ˆ</p>
            <p class="text-sm font-black text-slate-700">
              ${stats.yCount} <span class="text-[10px] text-slate-400">æ¯</span>
              <span class="text-[#CD5C5C] ml-1">$${stats.yTotal.toLocaleString()}</span>
            </p>
          </div>

          <div class="bg-white/80 p-3 rounded-[1.5rem] shadow-sm border border-white text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-[var(--main)]/20"></div>
            <p class="text-[10px] font-black text-[var(--main)] mb-1 tracking-widest">æœ¬æœˆçµ±è¨ˆ</p>
            <p class="text-sm font-black text-slate-700">
              ${stats.mCount} <span class="text-[10px] text-slate-400">æ¯</span>
              <span class="text-[var(--main-dark)] ml-1">$${stats.mTotal.toLocaleString()}</span>
            </p>
          </div>
        </div>

        <!-- Month Selector + Plus -->
        <div class="show_tell flex justify-center mb-3 shrink-0">
          <div class="flex items-center gap-3 bg-white/60 px-5 py-2 rounded-full border border-white/40 shadow-sm">
            <button id="prevMonth" class="text-[var(--main)] font-black text-lg active:scale-75 transition-transform">ã€ˆ</button>
            <p class="font-black text-base tracking-tighter text-[var(--main-dark)] min-w-[88px] text-center">
              ${year}.${String(month+1).padStart(2,'0')}
            </p>
            <button id="nextMonth" class="text-[var(--main)] font-black text-lg active:scale-75 transition-transform">ã€‰</button>

            <button id="goToday" class="ml-1 px-3 py-1.5 rounded-full bg-white/70 border border-white/60 text-[11px] font-black text-[var(--main-dark)] active:scale-95 transition-transform">ä»Šå¤©</button>

            <button id="quickAdd" class="w-10 h-10 rounded-full bg-white/70 border border-white/60 text-[var(--main-dark)] font-black text-xl leading-none active:scale-95 transition-transform flex items-center justify-center">+</button>
          </div>
        </div>

        <!-- Calendar (å›ºå®š 6 é€±é«˜åº¦) -->
        <div class="calendar-wrap bg-white/95 rounded-[2rem] shadow-sm border border-white mb-3 overflow-hidden shrink-0">
          <!-- âœ… æ˜ŸæœŸåˆ—ï¼šç”¨åŒä¸€å¥— cal-grid åƒæ•¸ -->
          <div class="cal-grid dow-grid text-center">
            ${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map((d,i)=>`
              <div class="text-[10px] font-black flex items-center justify-center" style="color:${(i===0||i===6)?'var(--weekend)':'#A5B997'}">${d}</div>
            `).join('')}
          </div>

          <!-- âœ… æ—¥æœŸæ ¼ï¼šæ°¸é  42 æ ¼ -->
          <div class="cal-grid pt-0">
            ${calendarCells}
          </div>
        </div>

        <!-- Bottom -->
        <div class="shrink-0 space-y-3 pb-3">
          <!-- TOP (ç½®ä¸­è²¼åœ¨é‚Šæ¡†) -->
          <button id="openTop" class="relative bg-white/70 px-4 pt-7 pb-4 rounded-[1.5rem] border border-white shadow-sm w-full active:scale-[0.99] transition-transform">
            <div class="absolute left-1/2 -top-3 -translate-x-1/2 px-7 py-2 rounded-full bg-[var(--main)] text-white font-black text-[12px] shadow-sm">
              TOP
            </div>
            <div class="grid grid-cols-3 gap-3">
              ${topCards}
            </div>
          </button>

          <!-- Good/Bad -->
          <div class="grid grid-cols-2 gap-3">
            <button id="openGood" class="bg-white/70 py-4 rounded-[1.2rem] border border-white flex items-center justify-center gap-2 text-[12px] font-black shadow-sm active:scale-95 transition-transform text-[var(--main-dark)]">
              ${thumbIcon("var(--main-dark)")}
              <span>è®šè®š (${goodCount})</span>
            </button>

            <button id="openBad" class="bg-white/70 py-4 rounded-[1.2rem] border border-white flex items-center justify-center gap-2 text-[12px] font-black shadow-sm active:scale-95 transition-transform text-[#B56B6B]">
              ${thumbDownIcon("#B56B6B")}
              <span>è¸©é›· (${badCount})</span>
            </button>
          </div>
        </div>
      `;

      wireMainEvents();

      if(state.isEditingTitle){
        const input = document.getElementById("titleInput");
        input.focus();
        input.addEventListener("blur", ()=>{
          const v = (input.value||"").trim();
          if(v) saveTitle(v);
          state.isEditingTitle = false;
          render();
        }, { once:true });
      }
    }

    /********************
     * Main Events
     ********************/
    function wireMainEvents(){
      const titleDisplay = document.getElementById("titleDisplay");
      if(titleDisplay){
        titleDisplay.onclick = ()=>{
          state.isEditingTitle = true;
          render();
        };
      }

      document.getElementById("prevMonth").onclick = ()=>{
        state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth()-1, 1);
        render();
      };
      document.getElementById("nextMonth").onclick = ()=>{
        state.currentDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth()+1, 1);
        render();
      };
      document.getElementById("goToday").onclick = ()=>{
        state.currentDate = new Date(today.getFullYear(), today.getMonth(), 1);
        render();
      };

      document.getElementById("quickAdd").onclick = ()=>{
        const d = new Date();
        // å¿«é€Ÿæ–°å¢ï¼šç›´æ¥æ‰“é–‹ä»Šå¤©
        if(d.getFullYear()!==state.currentDate.getFullYear() || d.getMonth()!==state.currentDate.getMonth()){
          state.currentDate = new Date(d.getFullYear(), d.getMonth(), 1);
          render();
        }
        openEditModal(d.getDate());
      };

      document.querySelectorAll("[data-day]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const day = Number(btn.getAttribute("data-day"));
          openEditModal(day);
        });
      });

      document.getElementById("openGood").onclick = ()=> openListModal("good");
      document.getElementById("openBad").onclick  = ()=> openListModal("bad");
      document.getElementById("openTop").onclick  = ()=> openMostDrinkModal();
    }

    /********************
     * Edit Modal
     ********************/
    function openEditModal(day){
      state.selectedDate = new Date(state.currentDate.getFullYear(), state.currentDate.getMonth(), day);
      const dateKey = formatDateKey(state.selectedDate);
      ensureDayArray(dateKey);

      const modal = document.createElement("div");
      modal.id = "editModal";
      modal.className = "fixed inset-0 bg-[var(--main-dark)]/40 backdrop-blur-md z-[100] flex items-end";
      modal.innerHTML = `
        <div class="modal-sheet bg-[#FAFBF9] w-full rounded-t-[2.5rem] p-6 pb-10 shadow-2xl no-scrollbar relative">
          <button id="closeEditX" class="absolute right-4 top-4 w-11 h-11 bg-white rounded-full flex items-center justify-center shadow-sm text-slate-300 text-xl">Ã—</button>

          <div class="flex justify-between items-center mb-5">
            <h3 class="text-xl font-black text-[var(--main-dark)]">${state.selectedDate.getMonth()+1}æœˆ${state.selectedDate.getDate()}æ—¥</h3>
            <div class="w-11 h-11"></div>
          </div>

          <div id="drinkList" class="space-y-4"></div>

          <button id="saveClose" class="w-full mt-6 py-4 bg-[var(--main-dark)] text-white rounded-[1.5rem] font-black text-base shadow-xl active:scale-95 transition-transform">
            å„²å­˜ç´€éŒ„
          </button>
        </div>
      `;

      const old = document.getElementById("editModal");
      if(old) old.remove();

      document.body.appendChild(modal);

      document.getElementById("closeEditX").onclick = closeEditModal;
      document.getElementById("saveClose").onclick = closeEditModal;

      renderDrinkCards();
    }

    function closeEditModal(){
      const m = document.getElementById("editModal");
      if(m) m.remove();
      closeShopPicker();
      render();
    }

    function renderDrinkCards(){
      const dateKey = formatDateKey(state.selectedDate);
      const list = ensureDayArray(dateKey);

      const container = document.getElementById("drinkList");
      container.innerHTML = "";

      for(let idx=0; idx<3; idx++){
        const drink = list[idx];
        const exists = !!drink;

        const canShow =
          idx===0 ||
          (list[idx-1] && (String(list[idx-1].item||"").trim() !== "" || String(list[idx-1].shop||"").trim() !== "")) ||
          exists;

        if(!canShow) continue;

        if(!exists){
          const add = document.createElement("div");
          add.className = "p-5 rounded-[2rem] bg-[#F2F4EF] border-2 border-dashed border-[#DDE4D1]";
          add.innerHTML = `
            <button class="w-full py-4 text-[#A5B997] font-black text-xs flex flex-col items-center gap-1 active:opacity-60">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <path d="M12 5v14M5 12h14"/>
              </svg>
              æ–°å¢ç¬¬ ${idx+1} æ¯
            </button>
          `;
          add.querySelector("button").onclick = ()=>{
            while(list.length <= idx) list.push(defaultDrink());
            saveData();
            renderDrinkCards();
          };
          container.appendChild(add);
          continue;
        }

        const card = document.createElement("div");
        card.className = "p-5 rounded-[2rem] bg-white shadow-sm border border-white space-y-3";
        card.innerHTML = `
          <div class="flex justify-between items-center">
            <span class="bg-[var(--main)] text-white px-3 py-1 rounded-full text-[10px] font-black tracking-widest">NO.${idx+1}</span>
            <div class="flex gap-2 items-center">
              <button class="p-2 rounded-lg ${drink.rating==='good' ? 'bg-[#E1EAD1] text-[var(--main-dark)]' : 'text-slate-300'}" data-action="good" data-idx="${idx}">
                ${thumbIcon("currentColor")}
              </button>
              <button class="p-2 rounded-lg ${drink.rating==='bad' ? 'bg-[#FEE2E2] text-[#B56B6B]' : 'text-slate-300'}" data-action="bad" data-idx="${idx}">
                ${thumbDownIcon("currentColor")}
              </button>
              <button class="text-slate-200 ml-1" data-action="del" data-idx="${idx}">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                  <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
              </button>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <button type="button"
              class="bg-[#F2F4EF] p-3 rounded-xl text-xs font-bold w-full border-none outline-none text-left active:opacity-60"
              data-action="pickShop" data-idx="${idx}">
              <span class="${(drink.shop||'').trim() ? 'text-slate-700' : 'text-slate-300'}">
                ${(drink.shop||"").trim() ? escapeHtml(drink.shop) : "åº—å®¶"}
              </span>
            </button>

            <input type="text" inputmode="text" autocomplete="off" autocapitalize="off"
              class="bg-[#F2F4EF] p-3 rounded-xl text-xs font-bold w-full border-none outline-none focus:ring-1 focus:ring-[var(--main)]"
              placeholder="å“é …" data-field="item" data-idx="${idx}" value="${escapeHtml(drink.item||"")}" />
          </div>

          <div class="space-y-1">
            <p class="text-[10px] font-black text-[#A5B997] ml-1">ç”œåº¦</p>
            <div class="flex flex-wrap gap-1.5">
              ${sugarOptions.map(opt=>`
                <button data-field="sugar" data-idx="${idx}" data-val="${opt}"
                  class="px-2.5 py-1.5 rounded-lg text-[10px] font-black transition-colors
                  ${drink.sugar===opt ? 'bg-[var(--main)] text-white shadow-sm' : 'bg-[#F2F4EF] text-[#A5B997]'}">
                  ${opt}
                </button>
              `).join("")}
            </div>
          </div>

          <div class="space-y-1">
            <p class="text-[10px] font-black text-[#A5B997] ml-1">å†°é‡</p>
            <div class="flex flex-wrap gap-1.5">
              ${iceOptions.map(opt=>`
                <button data-field="ice" data-idx="${idx}" data-val="${opt}"
                  class="px-2.5 py-1.5 rounded-lg text-[10px] font-black transition-colors
                  ${drink.ice===opt ? 'bg-[var(--main)] text-white shadow-sm' : 'bg-[#F2F4EF] text-[#A5B997]'}">
                  ${opt}
                </button>
              `).join("")}
            </div>
          </div>

          <div class="relative pt-2">
            <span class="absolute left-3 top-5 text-[var(--main)] font-black text-xs">$</span>
            <input type="number" inputmode="decimal"
              class="w-full bg-[#F2F4EF] pl-8 p-3 rounded-xl text-sm font-black border-none outline-none focus:ring-1 focus:ring-[var(--main)]"
              placeholder="é‡‘é¡" data-field="price" data-idx="${idx}" value="${escapeHtml(String(drink.price||""))}" />
          </div>
        `;
        container.appendChild(card);
      }

      wireModalEvents();
    }

    function wireModalEvents(){
      const modal = document.getElementById("editModal");
      if(!modal) return;

      const dateKey = formatDateKey(state.selectedDate);
      const list = ensureDayArray(dateKey);

      modal.querySelectorAll("[data-action]").forEach(btn=>{
        btn.onclick = ()=>{
          const idx = Number(btn.getAttribute("data-idx"));
          const act = btn.getAttribute("data-action");
          if(!list[idx]) return;

          if(act==="good"){
            list[idx].rating = (list[idx].rating==="good") ? null : "good";
            saveData(); renderDrinkCards(); return;
          }
          if(act==="bad"){
            list[idx].rating = (list[idx].rating==="bad") ? null : "bad";
            saveData(); renderDrinkCards(); return;
          }
          if(act==="del"){
            list.splice(idx,1);
            if(list.length===0) delete state.records[dateKey];
            saveData(); renderDrinkCards(); return;
          }
          if(act==="pickShop"){
            openShopPicker(idx); return;
          }
        };
      });

      modal.querySelectorAll("button[data-field='sugar'], button[data-field='ice']").forEach(btn=>{
        btn.onclick = ()=>{
          const idx = Number(btn.getAttribute("data-idx"));
          const field = btn.getAttribute("data-field");
          const val = btn.getAttribute("data-val");
          if(!list[idx]) return;
          list[idx][field] = val;
          saveData(); renderDrinkCards();
        };
      });

      modal.querySelectorAll("input[data-field]").forEach(inp=>{
        const idx = Number(inp.getAttribute("data-idx"));
        const field = inp.getAttribute("data-field");
        let composing = false;

        inp.addEventListener("compositionstart", ()=> composing = true);
        inp.addEventListener("compositionend", (e)=>{
          composing = false;
          applyValue(e.target.value);
        });
        inp.addEventListener("input", (e)=>{
          if(composing) return;
          applyValue(e.target.value);
        });
        inp.addEventListener("blur", ()=>{ renderDrinkCards(); });

        function applyValue(raw){
          if(!list[idx]) return;
          if(field === "price"){
            list[idx].price = raw === "" ? 0 : Number(raw);
          }else{
            list[idx][field] = raw;
          }
          saveData();
        }
      });
    }

    /********************
     * Shop Picker Modal (ç®¡ç†/å®Œæˆ + åˆªé™¤åº—å®¶)
     ********************/
    function openShopPicker(targetIdx){
      closeShopPicker();
      state.shopPicker = { open:true, targetIdx, manage:false };

      const modal = document.createElement("div");
      modal.id = "shopPicker";
      modal.className = "fixed inset-0 bg-black/55 backdrop-blur-md z-[120] flex items-center justify-center p-6";
      modal.innerHTML = `
        <div class="bg-white w-full rounded-[2.2rem] p-6 shadow-2xl relative" style="max-width:420px;">
          <button id="toggleManage" class="absolute right-5 top-5 px-3 py-1.5 rounded-full bg-[#F2F4EF] text-[var(--main-dark)] font-black text-[12px] active:scale-95 transition-transform">
            ç®¡ç†
          </button>

          <h3 class="text-center font-black mb-4" style="color:var(--main-dark)">é¸æ“‡åº—å®¶</h3>

          <div id="shopChips" class="flex flex-wrap gap-2 justify-center mb-4"></div>

          <button id="openAddShop" class="w-full py-3 rounded-xl font-black text-sm border border-[#E1EAD1] text-[var(--main-dark)] bg-white active:scale-95 transition-transform">
            ï¼‹ æ–°å¢åº—å®¶
          </button>

          <button id="closeShopPicker" class="w-full mt-3 py-3 bg-[var(--main-dark)] text-white rounded-xl font-black">é—œé–‰</button>
        </div>
      `;
      document.body.appendChild(modal);

      modal.addEventListener("click", (e)=>{
        if(e.target.id==="shopPicker") closeShopPicker();
      });

      document.getElementById("toggleManage").onclick = ()=>{
        state.shopPicker.manage = !state.shopPicker.manage;
        document.getElementById("toggleManage").textContent = state.shopPicker.manage ? "å®Œæˆ" : "ç®¡ç†";
        renderShopChips();
      };

      document.getElementById("closeShopPicker").onclick = closeShopPicker;
      document.getElementById("openAddShop").onclick = openAddShopDialog;

      renderShopChips();
    }

    function renderShopChips(){
      const box = document.getElementById("shopChips");
      if(!box) return;

      box.innerHTML = state.shops.map(s=>{
        const safe = escapeHtml(s);
        return `
          <div class="relative">
            <button class="px-4 py-2 rounded-full bg-[#F2F4EF] text-[var(--main-dark)] font-black text-sm active:scale-95 transition-transform"
              data-shop="${safe}">
              ${safe}
            </button>
            ${
              state.shopPicker.manage
              ? `<button class="absolute -right-2 -top-2 w-6 h-6 rounded-full bg-white border border-[#E1EAD1] text-slate-400 font-black text-[12px] flex items-center justify-center shadow-sm"
                   data-del-shop="${safe}">Ã—</button>`
              : ``
            }
          </div>
        `;
      }).join("");

      box.querySelectorAll("[data-shop]").forEach(btn=>{
        btn.onclick = ()=>{
          if(state.shopPicker.manage) return; // ç®¡ç†æ¨¡å¼ä¸é¸åº—
          const shop = btn.getAttribute("data-shop");
          applyShopToTarget(shop);
          closeShopPicker();
        };
      });

      box.querySelectorAll("[data-del-shop]").forEach(btn=>{
        btn.onclick = ()=>{
          const shop = btn.getAttribute("data-del-shop");
          state.shops = state.shops.filter(x=>x!==shop);
          saveShops();
          renderShopChips();
        };
      });
    }

    function closeShopPicker(){
      const m = document.getElementById("shopPicker");
      if(m) m.remove();
      state.shopPicker = { open:false, targetIdx:null, manage:false };
    }

    function openAddShopDialog(){
      const overlay = document.createElement("div");
      overlay.id = "addShopDialog";
      overlay.className = "fixed inset-0 bg-black/55 backdrop-blur-md z-[130] flex items-center justify-center p-6";
      overlay.innerHTML = `
        <div class="bg-white w-full rounded-[2.2rem] p-6 shadow-2xl" style="max-width:420px;">
          <h3 class="text-center font-black mb-4" style="color:var(--main-dark)">æ–°å¢åº—å®¶</h3>

          <input id="newShopInput" type="text" inputmode="text" autocomplete="off" autocapitalize="off"
            class="w-full bg-[#F2F4EF] p-4 rounded-2xl text-sm font-black border-none outline-none focus:ring-1 focus:ring-[var(--main)]"
            placeholder="è¼¸å…¥åº—å®¶åç¨±" />

          <div class="grid grid-cols-2 gap-3 mt-4">
            <button id="cancelAddShop" class="py-3 rounded-xl font-black text-sm border border-[#E1EAD1] text-[#B56B6B] bg-white">å–æ¶ˆ</button>
            <button id="confirmAddShop" class="py-3 rounded-xl font-black text-sm bg-[var(--main-dark)] text-white">æ–°å¢</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);

      const input = document.getElementById("newShopInput");
      input.focus();

      overlay.addEventListener("click",(e)=>{
        if(e.target.id==="addShopDialog") overlay.remove();
      });

      document.getElementById("cancelAddShop").onclick = ()=> overlay.remove();

      document.getElementById("confirmAddShop").onclick = ()=>{
        const v = (input.value||"").trim();
        if(!v) return;

        state.shops = uniqueList([v, ...state.shops]);
        saveShops();

        overlay.remove();
        renderShopChips();
      };
    }

    function applyShopToTarget(shop){
      const dateKey = formatDateKey(state.selectedDate);
      const list = ensureDayArray(dateKey);
      const idx = state.shopPicker.targetIdx;
      if(idx==null || !list[idx]) return;
      list[idx].shop = shop;
      saveData();
      renderDrinkCards();
    }

    /********************
     * Good/Bad List Modal
     ********************/
    function drinkLabel(drink){
      const shop = (drink.shop||"").trim();
      const item = (drink.item||"").trim();
      const s = drink.sugar || "ç„¡ç³–";
      const i = drink.ice || "å»å†°";
      const base = `${shop}${shop&&item?"-":""}${item}`.trim() || "ï¼ˆæœªå‘½åï¼‰";
      return `${base}ï¼ˆ${s}/${i}ï¼‰`;
    }

    function openListModal(type){
      const stats = calculateStats();
      const list = type==="good" ? stats.goodList : stats.badList;
      const title = type==="good" ? "ğŸ‘ è®šè®šæ¸…å–®" : "ğŸ‘ è¸©é›·ç´€éŒ„";
      const color = type==="good" ? "var(--main-dark)" : "#B56B6B";

      const items = list.length
        ? list.map(({drink, date})=>`
            <div class="flex justify-between gap-3 p-3 bg-[#F2F4EF] rounded-xl text-xs font-black">
              <span class="truncate">${escapeHtml(drinkLabel(drink))}</span>
              <span class="opacity-40 shrink-0">${escapeHtml(date.slice(5))}</span>
            </div>
          `).join("")
        : `<p class="text-center text-xs text-slate-300 py-6">å°šç„¡è³‡æ–™</p>`;

      const modal = document.createElement("div");
      modal.id = "detailModal";
      modal.className = "fixed inset-0 bg-black/60 backdrop-blur-md z-[110] flex items-center justify-center p-8";
      modal.innerHTML = `
        <div class="bg-white w-full rounded-[2.5rem] p-6 shadow-2xl relative" style="max-width:420px;">
          <button id="closeDetailX" class="absolute right-4 top-4 w-11 h-11 bg-white rounded-full flex items-center justify-center shadow-sm text-slate-300 text-xl">Ã—</button>
          <h3 class="text-center font-black mb-4" style="color:${color}">${title}</h3>
          <div class="max-h-64 overflow-y-auto space-y-2 no-scrollbar">
            ${items}
          </div>
          <button id="closeDetail" class="w-full mt-4 py-3 bg-[var(--main-dark)] text-white rounded-xl font-black">é—œé–‰</button>
        </div>
      `;
      const old = document.getElementById("detailModal");
      if(old) old.remove();
      document.body.appendChild(modal);

      modal.addEventListener("click", (e)=>{
        if(e.target.id==="detailModal") closeDetailModal();
      });
      document.getElementById("closeDetail").onclick = closeDetailModal;
      document.getElementById("closeDetailX").onclick = closeDetailModal;
    }

    function closeDetailModal(){
      const m = document.getElementById("detailModal");
      if(m) m.remove();
    }

    /********************
     * æˆ‘æœ€å¸¸å– Modal
     * âœ… åŠ ä¸Š 1/2/3 ç·¨è™Ÿ
     ********************/
    function openMostDrinkModal(){
      const stats = calculateStats();
      const list = stats.topCombos; // å·²æ˜¯ top3

      const items = list.length
        ? list.map((x, i)=>`
            <div class="flex items-center justify-between gap-3 p-4 bg-[#F2F4EF] rounded-2xl">
              <div class="flex items-center gap-3 min-w-0">
                <div class="w-6 text-center font-black text-[var(--main-dark)]">${i+1}</div>
                <div class="truncate font-black text-[13px] text-slate-700">
                  ${escapeHtml(`${x.combo}ï¼ˆ${x.bestVariant}ï¼‰`)}
                </div>
              </div>
              <div class="shrink-0 font-black text-[12px] text-slate-400">${x.count}æ¬¡</div>
            </div>
          `).join("")
        : `<p class="text-center text-xs text-slate-300 py-6">å°šç„¡è³‡æ–™</p>`;

      const modal = document.createElement("div");
      modal.id = "mostModal";
      modal.className = "fixed inset-0 bg-black/60 backdrop-blur-md z-[115] flex items-center justify-center p-8";
      modal.innerHTML = `
        <div class="bg-white w-full rounded-[2.5rem] p-6 shadow-2xl relative" style="max-width:420px;">
          <button id="closeMostX" class="absolute right-4 top-4 w-11 h-11 bg-white rounded-full flex items-center justify-center shadow-sm text-slate-300 text-xl">Ã—</button>
          <h3 class="text-center font-black mb-4 text-[var(--main-dark)]">æˆ‘æœ€å¸¸å–</h3>
          <div class="max-h-64 overflow-y-auto space-y-3 no-scrollbar">
            ${items}
          </div>
          <button id="closeMost" class="w-full mt-4 py-3 bg-[var(--main-dark)] text-white rounded-xl font-black">é—œé–‰</button>
        </div>
      `;

      const old = document.getElementById("mostModal");
      if(old) old.remove();
      document.body.appendChild(modal);

      modal.addEventListener("click", (e)=>{
        if(e.target.id==="mostModal") closeMostModal();
      });
      document.getElementById("closeMost").onclick = closeMostModal;
      document.getElementById("closeMostX").onclick = closeMostModal;
    }

    function closeMostModal(){
      const m = document.getElementById("mostModal");
      if(m) m.remove();
    }

    /********************
     * Boot
     ********************/
    render();
  </script>
</body>
</html>